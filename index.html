<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delivery App - Farmacia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- PWA Configuration -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Delivery Farmacia">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#2563eb">

    <!-- Manifest -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
        }

        body {
            background: var(--background);
            color: var(--text);
            padding-bottom: 80px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        /* Header Mobile */
        .header {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .login-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .login-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Tabs Mobile */
        .tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 60px;
            z-index: 99;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 0 0 auto;
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            font-size: 0.85rem;
            color: var(--secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 100px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Pedido Card Mobile */
        .pedido-card {
            background: var(--surface);
            margin: 8px 12px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .pedido-card:hover {
            transform: translateY(-2px);
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 8px;
        }

        .cliente-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .cliente-info .telefono {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .pedido-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .productos-list {
            margin: 12px 0;
        }

        .producto-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
            flex-wrap: wrap;
            gap: 4px;
        }

        .producto-detalle {
            font-size: 0.8rem;
            color: var(--secondary);
            flex-basis: 100%;
            margin-top: 2px;
        }

        .domicilio-info {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Floating Action Button Mobile */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal Mobile */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: var(--surface);
            padding: 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--secondary);
            cursor: pointer;
            padding: 4px;
            margin: -4px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 8px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .hidden {
            display: none;
        }

        .productos-seleccionados {
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .producto-seleccionado {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 8px;
        }

        .total-section {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Empty State Mobile */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 0.95rem;
        }

        /* Categor칤as Mobile */
        .categoria-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .categoria-medicamento { background: #dbeafe; color: #1e40af; }
        .categoria-inyecciones { background: #fef3c7; color: #92400e; }
        .categoria-cremas { background: #f0f9ff; color: #0369a1; }
        .categoria-ovulos { background: #fce7f3; color: #be185d; }
        .categoria-suspension { background: #f0fdf4; color: #15803d; }
        .categoria-operaciones { background: #fef7cd; color: #854d0e; }
        .categoria-lacteos { background: #ffedd5; color: #9a3412; }
        .categoria-colirio { background: #e0f2fe; color: #0369a1; }
        .categoria-otros { background: #f1f5f9; color: #475569; }

        /* Botones de acci칩n en productos Mobile */
        .producto-card {
            background: var(--surface);
            margin: 8px 12px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .producto-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .producto-precio {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
            white-space: nowrap;
        }

        /* Listados Mobile */
        .listado-card {
            background: var(--surface);
            margin: 8px 12px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }

        .listado-card:hover {
            transform: translateY(-2px);
        }

        .listado-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .listado-count {
            color: var(--secondary);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Botones de acci칩n Mobile */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
            min-height: 50px;
        }

        .btn-export {
            background: var(--success);
            color: white;
        }

        .btn-import {
            background: var(--primary);
            color: white;
        }

        .btn-clear {
            background: var(--danger);
            color: white;
        }

        /* Modal de detalles del pedido Mobile */
        .pedido-detalle {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .detalle-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 4px;
        }

        .detalle-label {
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .detalle-value {
            font-weight: 500;
            font-size: 0.9rem;
            text-align: right;
            word-break: break-word;
        }

        /* Bot칩n compartir Mobile */
        .btn-share {
            background: #25D366;
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            font-weight: 600;
        }

        .btn-share-provider {
            background: #8B5CF6;
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            font-weight: 600;
        }

        /* Estad칤sticas Mobile */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--secondary);
            font-size: 0.85rem;
        }

        .filtros-estadisticas {
            display: flex;
            gap: 12px;
            margin: 16px;
            flex-wrap: wrap;
        }

        .filtro-select {
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }

        /* Calendario Mobile */
        .calendar-container {
            margin: 16px 0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            padding: 12px 4px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #e2e8f0;
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day.other-month {
            color: #94a3b8;
        }

        .calendar-day.today {
            border: 2px solid var(--primary);
        }

        .fecha-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 8px;
            white-space: nowrap;
        }

        /* Notificaciones Mobile */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .notification-item {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
            padding: 16px;
            margin: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Login Mobile */
        .login-container {
            max-width: 100%;
            margin: 20px;
            padding: 0;
        }

        .login-card {
            background: var(--surface);
            padding: 32px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .user-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .user-type-btn {
            flex: 1;
            padding: 16px;
            border: 1px solid #cbd5e1;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
        }

        .user-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Bot칩n Compartir Lista */
        .btn-share-list {
            background: #3B82F6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        /* Producto Disponibilidad */
        .disponibilidad-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .disponible {
            background: #10b98120;
            color: #10b981;
        }
        
        .no-disponible {
            background: #ef444420;
            color: #ef4444;
        }

        /* Productos Nuevos */
        .producto-nuevo-tag {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .nuevos-container {
            background: linear-gradient(135deg, #fef3c7, #fef7cd);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 12px;
            border: 2px dashed #f59e0b;
        }
        
        .nuevos-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #92400e;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        /* NUEVO: Contenedor especial para productos nuevos */
        .nuevos-especial-container {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            padding: 20px;
            border-radius: 16px;
            margin: 16px 12px;
            border: 3px solid #f59e0b;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .nuevos-especial-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #92400e;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 16px;
            text-align: center;
            padding: 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 12px;
        }
        
        .nuevos-especial-producto {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Modal Compartir Lista */
        .share-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        .share-header {
            text-align: center;
            margin-bottom: 20px;
            color: #1e40af;
        }
        
        .share-footer {
            text-align: center;
            margin-top: 20px;
            color: #92400e;
            font-weight: bold;
        }

        /* Filtros Historial */
        .filtros-historial {
            display: flex;
            gap: 8px;
            margin: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filtro-btn {
            padding: 8px 12px;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .filtro-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Backup Management */
        .backup-list {
            margin-top: 16px;
        }
        
        .backup-item {
            background: var(--surface);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .backup-info {
            font-size: 0.9rem;
        }
        
        .backup-actions {
            display: flex;
            gap: 8px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .tab {
                padding: 12px 14px;
                font-size: 0.8rem;
                min-width: 90px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .pedido-actions {
                flex-direction: column;
            }
            
            .pedido-actions .btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            .filtros-historial {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 360px) {
            .header {
                padding: 10px 12px;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.75rem;
                min-width: 80px;
            }
            
            .modal-content {
                padding: 16px;
            }
        }

        /* Safe area support for notches */
        @supports(padding: max(0px)) {
            .header, .tabs, .fab {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
        }

        /* Touch improvements */
        button, .btn, .tab, .calendar-day {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Scroll improvements */
        .tab-content {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>游낀 Delivery Farmacia</h1>
            <div id="userSection">
                <!-- Se llena din치micamente seg칰n el estado de login -->
            </div>
        </div>

        <!-- Contenido para Clientes (sin login) -->
        <div id="clienteView">
            <div style="padding: 16px;">
                <h2 style="margin-bottom: 16px; font-size: 1.4rem;">Productos Disponibles</h2>
                
                <!-- NUEVO: Secci칩n especial para productos nuevos (para clientes) -->
                <div id="nuevos-especial-cliente" style="display: none;">
                    <!-- Productos nuevos especiales se cargan aqu칤 -->
                </div>
                
                <div id="lista-productos-cliente">
                    <!-- Productos para clientes -->
                </div>
                
                <button class="fab" onclick="abrirModalPedido()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Contenido para Usuarios Logueados -->
        <div id="usuarioView" style="display: none;">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('pendientes')">Pendientes</button>
                <button class="tab" onclick="cambiarTab('historial')">Historial</button>
                <button class="tab" onclick="cambiarTab('estadisticas')">Estad칤sticas</button>
                <button class="tab" onclick="cambiarTab('listados')">Listados</button>
                <button class="tab" onclick="cambiarTab('configuracion')">Configuraci칩n</button>
            </div>

            <!-- Contenido de Pesta침as -->
            <div id="pendientes-tab" class="tab-content">
                <div id="lista-pedidos-pendientes">
                    <!-- Los pedidos se cargan aqu칤 din치micamente -->
                </div>
            </div>

            <div id="historial-tab" class="tab-content" style="display: none;">
                <!-- Filtros de Historial -->
                <div class="filtros-historial">
                    <button class="filtro-btn active" onclick="cambiarFiltroHistorial('todos')">Todos</button>
                    <button class="filtro-btn" onclick="cambiarFiltroHistorial('hoy')">Hoy</button>
                    <input type="date" id="filtroFechaHistorial" class="filtro-select" onchange="filtrarHistorialPorFecha(this.value)" style="flex: 2;">
                    <select id="filtroMesHistorial" class="filtro-select" onchange="filtrarHistorialPorMes(this.value)">
                        <option value="">Mes</option>
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                    <select id="filtroAnioHistorial" class="filtro-select" onchange="filtrarHistorialPorAnio(this.value)">
                        <option value="">A침o</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                
                <div id="lista-historial">
                    <!-- Historial se carga aqu칤 -->
                </div>
            </div>

            <div id="estadisticas-tab" class="tab-content" style="display: none;">
                <div style="padding: 16px;">
                    <div class="filtros-estadisticas">
                        <select id="filtroPeriodo" class="filtro-select" onchange="cargarEstadisticas()">
                            <option value="dia">Hoy</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este Mes</option>
                            <option value="a침o">Este A침o</option>
                            <option value="todo">Todo</option>
                        </select>
                        <input type="month" id="filtroMes" class="filtro-select" onchange="cargarEstadisticas()" style="display: none;">
                        <input type="number" id="filtroA침o" class="filtro-select" placeholder="A침o" min="2020" max="2030" onchange="cargarEstadisticas()" style="display: none;">
                        <button class="btn" onclick="generarPDF()" style="background: var(--danger); color: white; padding: 12px;">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                    
                    <div class="stats-grid" id="estadisticas-contenido">
                        <!-- Estad칤sticas se cargan aqu칤 -->
                    </div>
                    
                    <div id="detalles-estadisticas" style="margin-top: 24px;">
                        <!-- Detalles de estad칤sticas -->
                    </div>
                </div>
            </div>

            <div id="listados-tab" class="tab-content" style="display: none;">
                <div style="padding: 16px;">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn" onclick="abrirModalNuevoListado()" style="background: var(--success); color: white; flex: 1; padding: 16px; min-width: 140px;">
                            <i class="fas fa-plus"></i> Nuevo Listado
                        </button>
                        <button class="btn" onclick="abrirModalImportarProductos()" style="background: var(--primary); color: white; flex: 1; padding: 16px; min-width: 140px;">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                    </div>
                    
                    <!-- NUEVO: Secci칩n especial para productos nuevos (para usuarios) -->
                    <div id="nuevos-especial-usuario" style="display: none;">
                        <!-- Productos nuevos especiales se cargan aqu칤 -->
                    </div>
                    
                    <!-- Productos Nuevos (versi칩n normal) -->
                    <div id="nuevos-productos-usuario" style="display: none;">
                        <!-- Productos nuevos se cargan aqu칤 -->
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-clear" onclick="limpiarTodo()">
                            <i class="fas fa-trash"></i> Limpiar Todo
                        </button>
                    </div>
                    
                    <div id="lista-listados">
                        <!-- Listados se cargan aqu칤 -->
                    </div>
                </div>
            </div>

            <div id="configuracion-tab" class="tab-content" style="display: none;">
                <div style="padding: 16px;">
                    <!-- Secci칩n de Gesti칩n de Usuarios (solo admin) -->
                    <div id="gestionUsuariosSection" style="display: none;">
                        <h3 style="margin-bottom: 16px; font-size: 1.2rem;">Gesti칩n de Usuarios</h3>
                        <button class="btn" onclick="abrirModalNuevoUsuario()" style="background: var(--success); color: white; margin-bottom: 16px; width: 100%; padding: 16px;">
                            <i class="fas fa-user-plus"></i> Crear Nuevo Vendedor
                        </button>
                        <div id="lista-usuarios">
                            <!-- Lista de usuarios -->
                        </div>
                    </div>

                    <h3 style="margin-bottom: 16px; font-size: 1.2rem;">Gesti칩n de Backups</h3>
                    <div class="action-buttons">
                        <button class="action-btn btn-export" onclick="exportarBackup()">
                            <i class="fas fa-download"></i> Exportar Backup
                        </button>
                        <button class="action-btn btn-import" onclick="document.getElementById('importBackupFile').click()">
                            <i class="fas fa-upload"></i> Importar Backup
                        </button>
                    </div>
                    <input type="file" id="importBackupFile" accept=".json" style="display: none;" onchange="importarBackup(event)">
                    
                    <!-- Lista de Backups -->
                    <div id="lista-backups" class="backup-list">
                        <!-- Backups se cargan aqu칤 -->
                    </div>
                    
                    <div style="margin-top: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 1.2rem;">Informaci칩n de la App</h3>
                        <div class="pedido-detalle">
                            <div class="detalle-item">
                                <span class="detalle-label">Total Pedidos:</span>
                                <span class="detalle-value" id="totalPedidos">0</span>
                            </div>
                            <div class="detalle-item">
                                <span class="detalle-label">Total Listados:</span>
                                <span class="detalle-value" id="totalListados">0</span>
                            </div>
                            <div class="detalle-item">
                                <span class="detalle-label">Total Productos:</span>
                                <span class="detalle-value" id="totalProductos">0</span>
                            </div>
                            <div class="detalle-item">
                                <span class="detalle-label">Productos Nuevos:</span>
                                <span class="detalle-value" id="totalProductosNuevos">0</span>
                            </div>
                            <div class="detalle-item">
                                <span class="detalle-label">칔ltimo Backup:</span>
                                <span class="detalle-value" id="ultimoBackup">Nunca</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot칩n Flotante -->
            <button class="fab" onclick="abrirModalPedido()">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Modal de Login -->
        <div id="modalLogin" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Iniciar Sesi칩n</h2>
                    <button class="close-btn" onclick="cerrarModalLogin()">&times;</button>
                </div>
                
                <form id="formLogin">
                    <div class="form-group">
                        <label for="loginUsuario">Usuario</label>
                        <input type="text" id="loginUsuario" class="form-control" placeholder="Ingresa tu usuario" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Contrase침a</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Ingresa tu contrase침a" required>
                    </div>
                    
                    <button type="submit" class="btn" style="background: var(--success); color: white; width: 100%; padding: 16px; font-size: 1rem;">
                        Iniciar Sesi칩n
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal para Nuevo Usuario (solo admin) -->
        <div id="modalNuevoUsuario" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Crear Nuevo Vendedor</h2>
                    <button class="close-btn" onclick="cerrarModalNuevoUsuario()">&times;</button>
                </div>
                
                <form id="formNuevoUsuario">
                    <div class="form-group">
                        <label for="nuevoUsuario">Usuario *</label>
                        <input type="text" id="nuevoUsuario" class="form-control" placeholder="Nombre de usuario" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nuevoTelefono">Tel칠fono *</label>
                        <input type="tel" id="nuevoTelefono" class="form-control" placeholder="N칰mero de tel칠fono" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nuevoPassword">Contrase침a *</label>
                        <input type="password" id="nuevoPassword" class="form-control" placeholder="Contrase침a" required>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="cerrarModalNuevoUsuario()" style="flex: 1; background: var(--secondary); color: white; padding: 16px;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn" style="flex: 1; background: var(--success); color: white; padding: 16px;">
                            Crear Usuario
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para Agregar/Editar Pedido -->
        <div id="modalPedido" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitulo">Nuevo Pedido</h2>
                    <button class="close-btn" onclick="cerrarModalPedido()">&times;</button>
                </div>
                
                <form id="formPedido">
                    <input type="hidden" id="pedidoId">
                    
                    <div class="form-group">
                        <label for="nombreCliente">Nombre del Cliente (Opcional)</label>
                        <input type="text" id="nombreCliente" class="form-control" placeholder="Ej: Juan P칠rez">
                    </div>
                    
                    <div class="form-group">
                        <label for="telefonoCliente">Tel칠fono *</label>
                        <input type="tel" id="telefonoCliente" class="form-control" placeholder="Ej: 12345678" required>
                    </div>
                    
                    <!-- MEJORA 2: Selector de qui칠n consigui칩 al cliente -->
                    <div class="form-group">
                        <label for="quienConsiguioCliente">쯈ui칠n consigui칩 este cliente? *</label>
                        <select id="quienConsiguioCliente" class="form-control" required onchange="actualizarTotalSegunQuienConsiguio()">
                            <option value="yo">Yo consigo al cliente (uso mi precio)</option>
                            <option value="proveedora">La proveedora consigue al cliente (uso su precio)</option>
                        </select>
                        <small style="color: var(--secondary);">Esto afectar치 el precio de los productos</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="fechaEntrega">Fecha de Entrega *</label>
                        <button type="button" class="btn" onclick="abrirCalendario()" style="background: var(--primary); color: white; width: 100%; padding: 16px;">
                            <i class="fas fa-calendar"></i> Seleccionar Fecha
                        </button>
                        <div id="fechaSeleccionada" class="total-section" style="background: #e2e8f0; font-size: 1rem;">
                            Hoy: ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </div>
                        <input type="hidden" id="fechaEntrega" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="form-group">
                        <label>Productos</label>
                        <button type="button" class="btn" onclick="abrirModalSeleccionProductos()" style="background: var(--primary); color: white; width: 100%; padding: 16px;">
                            <i class="fas fa-shopping-cart"></i> Seleccionar Productos
                        </button>
                        <div id="productosSeleccionados" class="productos-seleccionados">
                            <!-- Productos seleccionados aparecen aqu칤 -->
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="incluirDomicilio" onchange="toggleDomicilio()">
                        <label for="incluirDomicilio">Incluir domicilio</label>
                    </div>
                    
                    <div id="domicilioFields" class="hidden">
                        <div class="form-group">
                            <label for="direccion">Direcci칩n *</label>
                            <input type="text" id="direccion" class="form-control" placeholder="Direcci칩n completa">
                        </div>
                        
                        <div class="form-group">
                            <label for="precioDomicilio">Precio del Domicilio</label>
                            <input type="number" id="precioDomicilio" class="form-control" placeholder="0" value="0" onchange="actualizarTotal()">
                        </div>
                    </div>
                    
                    <div class="total-section">
                        Total: $<span id="totalPedido">0</span>
                        <div id="detallePrecio" style="font-size: 0.9rem; margin-top: 8px; color: var(--secondary);">
                            <!-- Aqu칤 se mostrar치 qu칠 precio se est치 usando -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" style="background: var(--success); color: white; width: 100%; padding: 16px;">
                        Guardar Pedido
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal para Calendario -->
        <div id="modalCalendario" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Seleccionar Fecha de Entrega</h2>
                    <button class="close-btn" onclick="cerrarCalendario()">&times;</button>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn" onclick="cambiarMes(-1)" style="padding: 12px;"><i class="fas fa-chevron-left"></i></button>
                        <h3 id="mesActual" style="font-size: 1.1rem;"></h3>
                        <button class="btn" onclick="cambiarMes(1)" style="padding: 12px;"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendario">
                        <!-- D칤as del calendario se cargan aqu칤 -->
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="seleccionarFecha()" style="background: var(--success); color: white; width: 100%; padding: 16px;">
                        Confirmar Fecha
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Seleccionar Productos -->
        <div id="modalProductos" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Seleccionar Productos</h2>
                    <button class="close-btn" onclick="cerrarModalProductos()">&times;</button>
                </div>
                
                <div id="lista-listados-modal" style="margin-bottom: 16px;">
                    <!-- Listados para seleccionar -->
                </div>
                
                <div class="form-group">
                    <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar producto..." onkeyup="filtrarProductos()">
                </div>
                
                <div id="lista-productos-modal" style="max-height: 300px; overflow-y: auto;">
                    <!-- Lista de productos para seleccionar -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="agregarProductosSeleccionados()" style="background: var(--success); color: white; width: 100%; padding: 16px;">
                        Agregar Seleccionados
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Detalles del Pedido -->
        <div id="modalDetallePedido" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Detalles del Pedido</h2>
                    <button class="close-btn" onclick="cerrarModalDetallePedido()">&times;</button>
                </div>
                
                <div id="detalle-pedido-contenido">
                    <!-- Detalles del pedido se cargan aqu칤 -->
                </div>
                
                <button class="btn-share" onclick="compartirPedido()">
                    <i class="fab fa-whatsapp"></i> Compartir con Cliente
                </button>
                
                <!-- MEJORA 3: Bot칩n para compartir con proveedora -->
                <button class="btn-share-provider" onclick="compartirConProveedora()" id="btnCompartirProveedora" style="display: none;">
                    <i class="fas fa-user-tie"></i> Compartir con Proveedora
                </button>
            </div>
        </div>

        <!-- Modal para Nuevo Listado -->
        <div id="modalNuevoListado" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalListadoTitulo">Nuevo Listado</h2>
                    <button class="close-btn" onclick="cerrarModalNuevoListado()">&times;</button>
                </div>
                
                <form id="formListado">
                    <input type="hidden" id="listadoId">
                    
                    <div class="form-group">
                        <label for="nombreListado">Nombre del Listado *</label>
                        <input type="text" id="nombreListado" class="form-control" placeholder="Ej: Medicamentos, L치cteos, etc." required>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="cerrarModalNuevoListado()" style="flex: 1; background: var(--secondary); color: white; padding: 16px;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn" style="flex: 1; background: var(--success); color: white; padding: 16px;">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para Importar Productos -->
        <div id="modalImportarProductos" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Importar Productos</h2>
                    <button class="close-btn" onclick="cerrarModalImportarProductos()">&times;</button>
                </div>
                
                <div class="form-group">
                    <label>Seleccionar Listado:</label>
                    <select id="listadoDestino" class="form-control">
                        <option value="">Seleccionar listado destino</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Pega tu lista de productos aqu칤:</label>
                    <textarea id="listaProductosTexto" class="form-control" rows="10" placeholder="Ej: 
游눍Amitritilina..............$500
游눌Vitamina B6 .........250
游빍Clotrimasol............$1000
游늷Cromado 3......$250
游볱Leche....................$950
..."></textarea>
                    <small style="color: var(--secondary);">
                        La app detectar치 autom치ticamente: 游눍Medicamentos, 游눌Inyecciones, 游빍Cremas, 游늷Material de Operaciones, 游볱L치cteos, etc.
                    </small>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button class="btn" onclick="cerrarModalImportarProductos()" style="flex: 1; background: var(--secondary); color: white; padding: 16px;">
                        Cancelar
                    </button>
                    <button class="btn" onclick="procesarListaProductos()" style="flex: 1; background: var(--success); color: white; padding: 16px;">
                        Importar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Gestionar Listado -->
        <div id="modalGestionListado" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalGestionTitulo">Gestionar Listado</h2>
                    <button class="close-btn" onclick="cerrarModalGestionListado()">&times;</button>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <button class="btn" onclick="compartirListadoActual()" style="background: #3B82F6; color: white;">
                        <i class="fas fa-share-alt"></i> Compartir Lista
                    </button>
                    <button class="btn" onclick="compartirListadoNuevosEspecial()" style="background: #f59e0b; color: white;">
                        <i class="fas fa-star"></i> Compartir Solo Nuevos
                    </button>
                </div>
                
                <div id="productos-listado" style="max-height: 400px; overflow-y: auto;">
                    <!-- Productos del listado -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="abrirModalNuevoProducto()" style="background: var(--success); color: white; width: 100%; padding: 16px;">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para Nuevo Producto -->
        <div id="modalNuevoProducto" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalProductoTitulo">Nuevo Producto</h2>
                    <button class="close-btn" onclick="cerrarModalNuevoProducto()">&times;</button>
                </div>
                
                <form id="formProducto">
                    <input type="hidden" id="productoId">
                    
                    <div class="form-group">
                        <label for="nombreProducto">Nombre del Producto *</label>
                        <input type="text" id="nombreProducto" class="form-control" placeholder="Ej: Dipirona, Leche, etc." required>
                    </div>
                    
                    <!-- MEJORA 2: Tres precios para cada producto -->
                    <div class="form-group">
                        <label for="precioCostoProducto">Precio de Costo (lo que te cuesta) *</label>
                        <input type="number" id="precioCostoProducto" class="form-control" placeholder="0" required>
                        <small style="color: var(--secondary);">Precio al que te lo da la proveedora</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="precioVentaEllaProducto">Precio de Venta de la Proveedora *</label>
                        <input type="number" id="precioVentaEllaProducto" class="form-control" placeholder="0" required>
                        <small style="color: var(--secondary);">Precio al que ella vende al p칰blico</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="precioProducto">Tu Precio de Venta *</label>
                        <input type="number" id="precioProducto" class="form-control" placeholder="0" required>
                        <small style="color: var(--secondary);">Tu precio (generalmente precio de ella + tu ganancia)</small>
                    </div>
                    
                    <!-- MEJORA 1: Agregar categor칤a "Colirio" -->
                    <div class="form-group">
                        <label for="categoriaProducto">Categor칤a *</label>
                        <select id="categoriaProducto" class="form-control" required>
                            <option value="">Seleccionar categor칤a</option>
                            <option value="medicamento">Medicamentos (Blister/Tabletas)</option>
                            <option value="inyecciones">Inyecciones</option>
                            <option value="cremas">Cremas/Geles/Ung칲entos</option>
                            <option value="ovulos">칍vulos</option>
                            <option value="suspension">Suspensiones</option>
                            <option value="operaciones">Material de Operaciones</option>
                            <option value="lacteos">L치cteos</option>
                            <option value="colirio">Colirio (Gotas para los ojos)</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="presentacionProducto">Presentaci칩n (Opcional)</label>
                        <input type="text" id="presentacionProducto" class="form-control" placeholder="Ej: Blister, Tableta, Frasco, etc.">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="productoDisponible" checked>
                        <label for="productoDisponible">Producto disponible</label>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="cerrarModalNuevoProducto()" style="flex: 1; background: var(--secondary); color: white; padding: 16px;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn" style="flex: 1; background: var(--success); color: white; padding: 16px;">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para Compartir Listado -->
        <div id="modalCompartirListado" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>游늶 Lista de Productos</h2>
                    <button class="close-btn" onclick="cerrarModalCompartirListado()">&times;</button>
                </div>
                
                <div class="share-header">
                    <h3 style="color: #1e40af;">游낀 FARMACIA DELIVERY 游낀</h3>
                    <p>游늰 Actualizado: <span id="fechaActualizacion"></span></p>
                    <p>춰Hola! 游녦 Aqu칤 est치 nuestra lista actualizada de productos:</p>
                </div>
                
                <div class="share-content" id="contenidoParaCompartir">
                    <!-- Contenido para compartir -->
                </div>
                
                <div class="share-footer">
                    <p>游뚴 *DOMICILIOS A $150* 游눯</p>
                    <p>游 춰Ll치manos para pedidos! 游</p>
                    <p>九 춰Gracias por tu preferencia! 九</p>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" onclick="copiarLista()" style="flex: 1; background: #3B82F6; color: white; padding: 16px;">
                        <i class="fas fa-copy"></i> Copiar Lista
                    </button>
                    <button class="btn" onclick="compartirListaWhatsApp()" style="flex: 1; background: #25D366; color: white; padding: 16px;">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registrado con 칠xito: ', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Error al registrar ServiceWorker: ', error);
                    });
            });
        }

        // Detectar si la app est치 instalada
        window.addEventListener('appinstalled', function(evt) {
            console.log('춰App instalada exitosamente!');
        });

        // Funci칩n para instalar la app
        function installApp() {
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuario acept칩 instalar la app');
                    }
                    window.deferredPrompt = null;
                });
            }
        }

        // Detectar si se puede instalar
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            window.deferredPrompt = e;
            console.log('App se puede instalar');
        });

        // Base de datos local
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let listados = JSON.parse(localStorage.getItem('listados')) || [];
        let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        let notificaciones = JSON.parse(localStorage.getItem('notificaciones')) || [];
        let backups = JSON.parse(localStorage.getItem('backups')) || [];
        let usuarioLogueado = JSON.parse(localStorage.getItem('usuarioLogueado')) || null;
        let productosSeleccionados = [];
        let pedidoEditando = null;
        let productoEditando = null;
        let listadoEditando = null;
        let listadoSeleccionado = null;
        let fechaSeleccionadaCalendario = new Date();
        let mesActualCalendario = new Date().getMonth();
        let a침oActualCalendario = new Date().getFullYear();
        let intervaloNotificaciones = null;
        let filtroHistorialActual = 'todos';

        // Configuraci칩n
        let config = JSON.parse(localStorage.getItem('config')) || {
            autoSave: true,
            ultimoBackup: null,
            backupFile: 'backup-delivery.json'
        };

        // Usuario administrador pre-configurado
        const ADMIN_USER = {
            usuario: "AleWiccans",
            password: "Karelia86",
            telefono: "",
            rol: "admin",
            fechaCreacion: new Date().toISOString()
        };

        // Inicializar la app
        document.addEventListener('DOMContentLoaded', function() {
            inicializarBaseDeDatos();
            cargarVistaSegunLogin();
            cargarPedidosPendientes();
            cargarListadosIniciales();
            actualizarEstadisticas();
            iniciarSistemaNotificaciones();
            cargarProductosNuevos();
            cargarListaBackups();
            
            // Configurar formularios
            document.getElementById('formPedido').addEventListener('submit', guardarPedido);
            document.getElementById('formProducto').addEventListener('submit', guardarProducto);
            document.getElementById('formListado').addEventListener('submit', guardarListado);
            document.getElementById('formLogin').addEventListener('submit', iniciarSesion);
            document.getElementById('formNuevoUsuario').addEventListener('submit', crearNuevoUsuario);
            
            // Configurar filtros de estad칤sticas
            document.getElementById('filtroPeriodo').addEventListener('change', function() {
                const periodo = this.value;
                document.getElementById('filtroMes').style.display = periodo === 'mes' ? 'block' : 'none';
                document.getElementById('filtroA침o').style.display = periodo === 'a침o' ? 'block' : 'none';
            });
            
            // Establecer a침o actual en filtros
            const a침oActual = new Date().getFullYear();
            document.getElementById('filtroAnioHistorial').value = a침oActual.toString();
            document.getElementById('filtroA침o').value = a침oActual;
        });

        // ================ SISTEMA DE GUARDADO AUTOM츼TICO ================
        function guardarEnLocalStorage() {
            try {
                localStorage.setItem('pedidos', JSON.stringify(pedidos));
                localStorage.setItem('listados', JSON.stringify(listados));
                localStorage.setItem('usuarios', JSON.stringify(usuarios));
                localStorage.setItem('notificaciones', JSON.stringify(notificaciones));
                localStorage.setItem('backups', JSON.stringify(backups));
                localStorage.setItem('config', JSON.stringify(config));
                
                if (usuarioLogueado) {
                    localStorage.setItem('usuarioLogueado', JSON.stringify(usuarioLogueado));
                }
                
                actualizarEstadisticas();
                
                // Guardar autom치ticamente si est치 activado
                if (config.autoSave) {
                    guardarBackupAutomatico();
                }
                
                console.log('Datos guardados autom치ticamente');
            } catch (error) {
                console.error('Error al guardar datos:', error);
            }
        }

        function guardarBackupAutomatico() {
            const data = {
                pedidos: pedidos,
                listados: listados,
                usuarios: usuarios,
                notificaciones: notificaciones,
                fechaBackup: new Date().toISOString(),
                version: '6.0' // Nueva versi칩n con todas las mejoras
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            
            // Crear blob y descargar autom치ticamente si es necesario
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            // Para usar un solo archivo, guardamos la referencia en config
            config.ultimoBackup = new Date().toISOString();
            config.backupData = dataStr; // Guardamos los datos directamente
            
            // Tambi칠n guardamos en localStorage como backup secundario
            const backupInfo = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                datos: data,
                automatico: true
            };
            
            // Mantener solo los 칰ltimos 10 backups
            backups.unshift(backupInfo);
            if (backups.length > 10) {
                backups = backups.slice(0, 10);
            }
            
            localStorage.setItem('config', JSON.stringify(config));
            localStorage.setItem('backups', JSON.stringify(backups));
            
            URL.revokeObjectURL(url);
            
            // Actualizar UI
            document.getElementById('ultimoBackup').textContent = new Date().toLocaleString();
            cargarListaBackups();
        }

        // ================ MEJORA 1: CATEGOR칈A "COLIRIO" ================
        function obtenerNombreCategoria(categoria) {
            const nombres = {
                'medicamento': '游눍 Medicamentos (Blister/Tabletas)',
                'inyecciones': '游눌 Inyecciones',
                'cremas': '游빍 Cremas/Geles/Ung칲entos',
                'ovulos': '游댮 칍vulos',
                'suspension': '游꽆 Suspensiones',
                'operaciones': '游늷 Material de Operaciones',
                'lacteos': '游볱 L치cteos',
                'colirio': '游녜 Colirio (Gotas para los ojos)', // NUEVA CATEGOR칈A
                'otros': '游닍 Otros Productos'
            };
            return nombres[categoria] || categoria;
        }

        function ordenarProductosPorCategoria(productos) {
            // Agrupar por categor칤a
            const productosPorCategoria = {};
            
            productos.forEach(producto => {
                if (!productosPorCategoria[producto.categoria]) {
                    productosPorCategoria[producto.categoria] = [];
                }
                productosPorCategoria[producto.categoria].push(producto);
            });
            
            // Ordenar cada grupo alfab칠ticamente
            Object.keys(productosPorCategoria).forEach(categoria => {
                productosPorCategoria[categoria].sort((a, b) => 
                    a.nombre.localeCompare(b.nombre)
                );
            });
            
            // Convertir a array y ordenar por orden de categor칤as
            const categoriasOrden = [
                'medicamento', 'inyecciones', 'cremas', 'ovulos', 
                'suspension', 'operaciones', 'lacteos', 'colirio', 'otros'
            ];
            
            return categoriasOrden
                .filter(categoria => productosPorCategoria[categoria])
                .map(categoria => ({
                    categoria: categoria,
                    productos: productosPorCategoria[categoria]
                }));
        }

        function obtenerNombreCategoriaCompartir(categoria) {
            const nombres = {
                'medicamento': '游눍 *MEDICAMENTOS (BLISTER/TABLETAS)*',
                'inyecciones': '游눌 *INYECCIONES*',
                'cremas': '游빍 *CREMAS/GELES/UNGUENTOS*',
                'ovulos': '游댮 *칍VULOS*',
                'suspension': '游꽆 *SUSPENSIONES*',
                'operaciones': '游늷 *MATERIAL DE OPERACIONES*',
                'lacteos': '游볱 *L츼CTEOS*',
                'colirio': '游녜 *COLIRIO (GOTAS PARA LOS OJOS)*', // NUEVA CATEGOR칈A
                'otros': '游닍 *OTROS PRODUCTOS*'
            };
            return nombres[categoria] || categoria.toUpperCase();
        }

        function obtenerEmojiCategoria(categoria) {
            const emojis = {
                'medicamento': '游눍',
                'inyecciones': '游눌',
                'cremas': '游빍',
                'ovulos': '游댮',
                'suspension': '游꽆',
                'operaciones': '游늷',
                'lacteos': '游볱',
                'colirio': '游녜', // NUEVO EMOJI
                'otros': '游닍'
            };
            return emojis[categoria] || '游닍';
        }

        // ================ MEJORA 2: SISTEMA DE DOS PRECIOS Y QUI칄N CONSIGUE EL CLIENTE ================
        function actualizarTotalSegunQuienConsiguio() {
            const quienConsiguio = document.getElementById('quienConsiguioCliente').value;
            const detallePrecio = document.getElementById('detallePrecio');
            
            if (quienConsiguio === 'yo') {
                detallePrecio.textContent = "Usando tu precio (con tu ganancia)";
                detallePrecio.style.color = "#10b981";
            } else {
                detallePrecio.textContent = "Usando precio de la proveedora (sin tu ganancia extra)";
                detallePrecio.style.color = "#8B5CF6";
            }
            
            actualizarTotal();
        }

        function calcularTotalPedido(pedido) {
            const quienConsiguio = pedido.quienConsiguio || 'yo'; // Por defecto, si no est치 definido
            let totalProductos = 0;
            
            pedido.productos.forEach(p => {
                // Usar el precio correcto seg칰n qui칠n consigui칩 al cliente
                const precio = quienConsiguio === 'yo' ? p.precio : (p.precioVentaElla || p.precio);
                totalProductos += precio * p.cantidad;
            });
            
            return totalProductos + (pedido.precioDomicilio || 0);
        }

        function calcularGananciaPedido(pedido) {
            const quienConsiguio = pedido.quienConsiguio || 'yo';
            let gananciaTotal = 0;
            
            pedido.productos.forEach(productoPedido => {
                const productoOriginal = buscarProductoOriginal(productoPedido.id);
                if (productoOriginal) {
                    let precioVenta;
                    
                    if (quienConsiguio === 'yo') {
                        // Si t칰 consigues al cliente, usas tu precio
                        precioVenta = productoPedido.precio;
                    } else {
                        // Si la proveedora consigue al cliente, usas su precio de venta
                        precioVenta = productoPedido.precioVentaElla || productoPedido.precio;
                    }
                    
                    const gananciaProducto = (precioVenta - productoOriginal.precioCosto) * productoPedido.cantidad;
                    gananciaTotal += gananciaProducto;
                }
            });
            
            return gananciaTotal + (pedido.precioDomicilio || 0);
        }

        function calcularCostoPedido(pedido) {
            let costoTotal = 0;
            pedido.productos.forEach(productoPedido => {
                const productoOriginal = buscarProductoOriginal(productoPedido.id);
                if (productoOriginal && productoOriginal.precioCosto) {
                    costoTotal += productoOriginal.precioCosto * productoPedido.cantidad;
                }
            });
            return costoTotal;
        }

        // ================ MEJORA 3: BOT칍N COMPARTIR PARA PROVEEDORA (UNICO Y MULTIPLE) ================
        function compartirConProveedora(pedidoEspecifico = null) {
            // Si se pasa un pedido espec칤fico, solo comparte ese
            // Si no, usa el pedidoACompartir (para el modal de detalles)
            const pedido = pedidoEspecifico || window.pedidoACompartir;
            if (!pedido) return;
            
            let mensaje = `游늶 *INFORME PARA PROVEEDORA* 游늶\n\n`;
            mensaje += `*Pedido de:* ${pedido.nombreCliente || 'Cliente'}\n`;
            mensaje += `*Tel칠fono:* ${pedido.telefono}\n`;
            mensaje += `*Fecha:* ${new Date(pedido.fechaEntrega).toLocaleDateString('es-ES')}\n`;
            mensaje += `*Consigui칩:* ${pedido.quienConsiguio === 'proveedora' ? 'Proveedora' : 'T칰'}\n\n`;
            
            mensaje += `*Productos (a precio de costo):*\n`;
            
            let totalCosto = 0;
            let totalVenta = calcularTotalPedido(pedido);
            let gananciaDomicilio = pedido.precioDomicilio || 0;
            
            pedido.productos.forEach(p => {
                const productoOriginal = buscarProductoOriginal(p.id);
                // MEJORA: Usar el precio correcto seg칰n qui칠n consigui칩 al cliente
                const precioUsado = pedido.quienConsiguio === 'yo' ? 
                    (productoOriginal ? productoOriginal.precioVentaElla || productoOriginal.precio : p.precio) :
                    (productoOriginal ? productoOriginal.precioVentaElla || productoOriginal.precio : p.precio);
                
                const precioCosto = productoOriginal ? productoOriginal.precioCosto : 0;
                const subtotalCosto = precioCosto * p.cantidad;
                totalCosto += subtotalCosto;
                
                mensaje += ` ${p.cantidad}x ${p.nombre} ($${precioCosto} c/u) - $${subtotalCosto}\n`;
            });
            
            const gananciaNeta = totalVenta - totalCosto + gananciaDomicilio;
            
            mensaje += `\n*TOTAL A PAGAR A PROVEEDORA: $${totalCosto}*\n\n`;
            mensaje += `游눺 *Resumen financiero:*\n`;
            mensaje += `- Total venta al cliente: $${totalVenta}\n`;
            mensaje += `- Costo productos: $${totalCosto}\n`;
            mensaje += `- Ganancia domicilio: $${gananciaDomicilio}\n`;
            mensaje += `- Ganancia neta: $${gananciaNeta}\n\n`;
            mensaje += `九 Pedido completado`;
            
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
        }

        // NUEVA FUNCI칍N: COMPARTIR RESUMEN DE M칔LTIPLES PEDIDOS
        function compartirResumenProveedoraMultiple() {
            // Obtener pedidos completados de hoy
            const pedidosCompletados = pedidos.filter(p => p.completado);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const pedidosHoy = pedidosCompletados.filter(p => {
                const fechaPedido = new Date(p.fechaCompletado || p.fecha);
                fechaPedido.setHours(0, 0, 0, 0);
                return fechaPedido.getTime() === hoy.getTime();
            });
            
            if (pedidosHoy.length === 0) {
                alert('No hay pedidos completados hoy para reportar');
                return;
            }
            
            // Preguntar cu치ntos pedidos quiere incluir
            let mensajeConfirmacion = `Tienes ${pedidosHoy.length} pedidos completados hoy.\n`;
            mensajeConfirmacion += `쯈uieres compartir todos los pedidos o seleccionar algunos?`;
            
            // Por simplicidad, primero har칠 que comparta todos
            // Luego puedes agregar un modal para seleccionar cu치les
            
            let mensaje = `游늵 *REPORTE DIARIO PARA PROVEEDORA* 游늵\n\n`;
            mensaje += `*Fecha:* ${hoy.toLocaleDateString('es-ES')}\n`;
            mensaje += `*Total pedidos:* ${pedidosHoy.length}\n`;
            mensaje += `轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n\n`;
            
            let totalGeneralCosto = 0;
            let totalGeneralVenta = 0;
            let gananciaTotal = 0;
            let domicilioTotal = 0;
            
            pedidosHoy.forEach((pedido, index) => {
                mensaje += `*Pedido ${index + 1}:*\n`;
                mensaje += `游녻 Cliente: ${pedido.nombreCliente || 'Cliente'}\n`;
                mensaje += `游 Tel칠fono: ${pedido.telefono}\n`;
                mensaje += `游논 Consigui칩: ${pedido.quienConsiguio === 'proveedora' ? 'Proveedora' : 'T칰'}\n\n`;
                
                let totalPedidoCosto = 0;
                let totalPedidoVenta = calcularTotalPedido(pedido);
                
                mensaje += `游 Productos:\n`;
                pedido.productos.forEach(p => {
                    const productoOriginal = buscarProductoOriginal(p.id);
                    const precioCosto = productoOriginal ? productoOriginal.precioCosto : 0;
                    const subtotalCosto = precioCosto * p.cantidad;
                    totalPedidoCosto += subtotalCosto;
                    
                    mensaje += `   ${p.cantidad}x ${p.nombre} - $${subtotalCosto}\n`;
                });
                
                const gananciaPedido = totalPedidoVenta - totalPedidoCosto + (pedido.precioDomicilio || 0);
                
                mensaje += `\n游눯 *Resumen del pedido:*\n`;
                mensaje += `- Total costo: $${totalPedidoCosto}\n`;
                mensaje += `- Total venta: $${totalPedidoVenta}\n`;
                mensaje += `- Ganancia: $${gananciaPedido}\n`;
                mensaje += `轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n\n`;
                
                totalGeneralCosto += totalPedidoCosto;
                totalGeneralVenta += totalPedidoVenta;
                gananciaTotal += gananciaPedido;
                domicilioTotal += pedido.precioDomicilio || 0;
            });
            
            mensaje += `游늳 *RESUMEN GENERAL DEL D칈A:*\n\n`;
            mensaje += `游눯 *Total a pagar a proveedora:* $${totalGeneralCosto}\n`;
            mensaje += `游눳 *Total ventas del d칤a:* $${totalGeneralVenta}\n`;
            mensaje += `游뚴 *Total domicilios:* $${domicilioTotal}\n`;
            mensaje += `游늳 *Ganancia total del d칤a:* $${gananciaTotal}\n\n`;
            mensaje += `九 *Reporte generado autom치ticamente*\n`;
            mensaje += `낋 *Hora:* ${new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}`;
            
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
        }

        // ================ HISTORIAL ORDENADO Y FILTRADO ================
        function cargarHistorial() {
            const container = document.getElementById('lista-historial');
            let pedidosCompletados = pedidos.filter(p => p.completado);
            
            // Ordenar de m치s reciente a m치s antiguo
            pedidosCompletados.sort((a, b) => {
                return new Date(b.fechaCompletado || b.fecha) - new Date(a.fechaCompletado || a.fecha);
            });
            
            // Aplicar filtro actual
            pedidosCompletados = aplicarFiltroHistorial(pedidosCompletados);
            
            if (pedidosCompletados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>No hay historial de pedidos</h3>
                        <p>${filtroHistorialActual !== 'todos' ? 'Intenta con otros filtros' : 'Los pedidos completados aparecer치n aqu칤'}</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar por fecha
            const agrupados = {};
            pedidosCompletados.forEach(pedido => {
                const fecha = new Date(pedido.fechaCompletado || pedido.fecha).toLocaleDateString();
                if (!agrupados[fecha]) agrupados[fecha] = [];
                agrupados[fecha].push(pedido);
            });
            
            container.innerHTML = Object.entries(agrupados).map(([fecha, pedidosDia]) => `
                <div style="margin: 16px;">
                    <h3 style="padding: 8px 16px; background: #e2e8f0; border-radius: 8px;">${fecha}
                        <div style="float: right; display: flex; gap: 4px;">
                            <button onclick="compartirResumenProveedoraMultiple()" style="background: #7C3AED; color: white; border: none; border-radius: 8px; padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fas fa-list"></i> Todos Hoy
                            </button>
                        </div>
                    </h3>
                    ${pedidosDia.map(pedido => `
                        <div class="pedido-card" onclick="verDetallePedido(${pedido.id})">
                            <div class="pedido-header">
                                <div class="cliente-info">
                                    <h3>${pedido.nombreCliente || 'Cliente'}</h3>
                                    <div class="telefono">${pedido.telefono}</div>
                                    <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                                        <i class="fas fa-calendar"></i> ${new Date(pedido.fechaEntrega).toLocaleDateString('es-ES')}
                                        <span class="categoria-badge" style="background: ${pedido.quienConsiguio === 'proveedora' ? '#8B5CF6' : '#10b981'}; color: white; margin-left: 8px;">
                                            ${pedido.quienConsiguio === 'proveedora' ? 'Proveedora' : 'T칰'}
                                        </span>
                                    </div>
                                </div>
                                <div class="pedido-actions">
                                    <div style="color: var(--success); margin-right: 8px;">
                                        <i class="fas fa-check-circle"></i> Completado
                                    </div>
                                    <button class="btn btn-danger" onclick="event.stopPropagation(); eliminarPedido(${pedido.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="productos-list">
                                ${pedido.productos.slice(0, 2).map(p => `
                                    <div class="producto-item">
                                        <span>${p.cantidad}x ${p.nombre}</span>
                                        <span class="producto-detalle">($${p.precio} c/u) - $${p.precio * p.cantidad}</span>
                                    </div>
                                `).join('')}
                                ${pedido.productos.length > 2 ? `<div style="color: var(--secondary); font-size: 0.8rem;">... y ${pedido.productos.length - 2} m치s</div>` : ''}
                            </div>
                            
                            <div style="text-align: right; margin-top: 12px; font-weight: bold;">
                                Total: $${calcularTotalPedido(pedido)}
                                ${usuarioLogueado ? `<br><small style="color: #10b981;">Ganancia: $${calcularGananciaPedido(pedido)}</small>` : ''}
                            </div>
                            
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button class="btn" onclick="event.stopPropagation(); compartirConProveedora(${pedido.id})" style="background: #8B5CF6; color: white; flex: 1; padding: 8px; font-size: 0.8rem;">
                                    <i class="fas fa-user-tie"></i> Compartir con Proveedora
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function cambiarFiltroHistorial(filtro) {
            filtroHistorialActual = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.filtros-historial .filtro-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Limpiar otros filtros
            document.getElementById('filtroFechaHistorial').value = '';
            document.getElementById('filtroMesHistorial').value = '';
            document.getElementById('filtroAnioHistorial').value = new Date().getFullYear().toString();
            
            cargarHistorial();
        }

        function filtrarHistorialPorFecha(fecha) {
            filtroHistorialActual = 'fecha';
            cargarHistorial();
        }

        function filtrarHistorialPorMes(mes) {
            filtroHistorialActual = 'mes';
            cargarHistorial();
        }

        function filtrarHistorialPorAnio(anio) {
            filtroHistorialActual = 'anio';
            cargarHistorial();
        }

        function aplicarFiltroHistorial(pedidosList) {
            switch (filtroHistorialActual) {
                case 'hoy':
                    const hoy = new Date();
                    hoy.setHours(0, 0, 0, 0);
                    return pedidosList.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado || p.fecha);
                        fechaPedido.setHours(0, 0, 0, 0);
                        return fechaPedido.getTime() === hoy.getTime();
                    });
                    
                case 'fecha':
                    const fechaFiltro = document.getElementById('filtroFechaHistorial').value;
                    if (!fechaFiltro) return pedidosList;
                    
                    const fecha = new Date(fechaFiltro);
                    fecha.setHours(0, 0, 0, 0);
                    
                    return pedidosList.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado || p.fecha);
                        fechaPedido.setHours(0, 0, 0, 0);
                        return fechaPedido.getTime() === fecha.getTime();
                    });
                    
                case 'mes':
                    const mes = document.getElementById('filtroMesHistorial').value;
                    const anioMes = document.getElementById('filtroAnioHistorial').value || new Date().getFullYear().toString();
                    
                    if (!mes) return pedidosList;
                    
                    const inicioMes = new Date(anioMes, parseInt(mes) - 1, 1);
                    const finMes = new Date(anioMes, parseInt(mes), 0);
                    
                    return pedidosList.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado || p.fecha);
                        return fechaPedido >= inicioMes && fechaPedido <= finMes;
                    });
                    
                case 'anio':
                    const anio = document.getElementById('filtroAnioHistorial').value;
                    if (!anio) return pedidosList;
                    
                    const inicioAnio = new Date(anio, 0, 1);
                    const finAnio = new Date(anio, 11, 31);
                    
                    return pedidosList.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado || p.fecha);
                        return fechaPedido >= inicioAnio && fechaPedido <= finAnio;
                    });
                    
                default:
                    return pedidosList;
            }
        }

        // ================ MEJORA 4: SISTEMA DE PRODUCTOS NUEVOS MEJORADO ================
        function cargarProductosNuevos() {
            const unaSemanaAtras = new Date();
            unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7); // SOLO 1 SEMANA
            
            let todosProductosNuevos = [];
            
            // Recolectar todos los productos nuevos de todos los listados
            listados.forEach(listado => {
                if (listado.productos) {
                    const productosNuevos = listado.productos.filter(p => {
                        // SOLO productos que tengan fecha de creaci칩n
                        if (!p.fechaCreacion) return false;
                        
                        const fechaCreacion = new Date(p.fechaCreacion);
                        
                        // Debe ser menor a 1 semana
                        const esNuevo = fechaCreacion >= unaSemanaAtras;
                        
                        // NO debe estar marcado como "agotado" (disponible = false)
                        const estaDisponible = p.disponible !== false;
                        
                        return esNuevo && estaDisponible;
                    });
                    
                    todosProductosNuevos = todosProductosNuevos.concat(productosNuevos);
                }
            });
            
            // Ordenar por fecha de creaci칩n (m치s nuevos primero)
            todosProductosNuevos.sort((a, b) => {
                return new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0);
            });
            
            // Actualizar contador en configuraci칩n
            document.getElementById('totalProductosNuevos').textContent = todosProductosNuevos.length;
            
            // ========== SECCI칍N ESPECIAL PARA PRODUCTOS NUEVOS (MEJORADA) ==========
            
            // Para usuarios logueados
            const containerEspecialUsuario = document.getElementById('nuevos-especial-usuario');
            if (todosProductosNuevos.length > 0) {
                containerEspecialUsuario.style.display = 'block';
                containerEspecialUsuario.innerHTML = `
                    <div class="nuevos-especial-container">
                        <div class="nuevos-especial-title">
                            <i class="fas fa-star"></i>
                            <span>游 춰PRODUCTOS NUEVOS! 游</span>
                            <i class="fas fa-star"></i>
                        </div>
                        <p style="text-align: center; color: #92400e; margin-bottom: 16px; font-weight: bold;">
                            游꿀 춰Novedades reci칠n llegadas! 游꿀
                        </p>
                        <div class="productos-list">
                            ${todosProductosNuevos.map(producto => {
                                // Calcular d칤as desde que se cre칩
                                const fechaCreacion = new Date(producto.fechaCreacion);
                                const hoy = new Date();
                                const diferenciaDias = Math.floor((hoy - fechaCreacion) / (1000 * 60 * 60 * 24));
                                const diasTexto = diferenciaDias === 0 ? "Hoy" : 
                                                diferenciaDias === 1 ? "Ayer" : 
                                                `Hace ${diferenciaDias} d칤as`;
                                
                                return `
                                    <div class="nuevos-especial-producto">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                            <h4 style="font-size: 1.1rem; font-weight: bold;">
                                                ${producto.nombre}
                                                <span class="producto-nuevo-tag">NUEVO</span>
                                            </h4>
                                            <span style="font-size: 0.8rem; color: #f59e0b; font-weight: bold;">
                                                <i class="far fa-clock"></i> ${diasTexto}
                                            </span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--secondary);">
                                            <div><strong>游눳 Tu precio:</strong> $${producto.precio}</div>
                                            <div><strong>游놀꽳눺 Precio proveedora:</strong> $${producto.precioVentaElla || producto.precio}</div>
                                            ${usuarioLogueado ? `<div style="color: #10b981;"><strong>游눯 Costo:</strong> $${producto.precioCosto || 0}</div>` : ''}
                                            ${producto.presentacion ? `<div><strong>游닍 Presentaci칩n:</strong> ${producto.presentacion}</div>` : ''}
                                            <span class="categoria-badge categoria-${producto.categoria}" style="margin-top: 8px;">
                                                ${obtenerEmojiCategoria(producto.categoria)} ${producto.categoria}
                                            </span>
                                        </div>
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <span class="disponibilidad-badge ${producto.disponible !== false ? 'disponible' : 'no-disponible'}" 
                                                  onclick="toggleDisponibilidadProducto(${producto.id}, ${listadoSeleccionado ? listadoSeleccionado.id : 'null'})">
                                                <i class="fas fa-${producto.disponible !== false ? 'check' : 'times'}"></i>
                                                ${producto.disponible !== false ? 'Disponible' : 'No disponible'}
                                            </span>
                                            <button class="btn" onclick="agregarProductoAPedido(${producto.id})" style="background: var(--primary); color: white; padding: 6px 12px; font-size: 0.8rem;">
                                                <i class="fas fa-cart-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="text-align: center; margin-top: 16px; color: #92400e; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> Estos productos desaparecer치n autom치ticamente despu칠s de 7 d칤as
                        </div>
                    </div>
                `;
            } else {
                containerEspecialUsuario.style.display = 'none';
            }
            
            // Para clientes (sin login)
            const containerEspecialCliente = document.getElementById('nuevos-especial-cliente');
            const productosDisponiblesCliente = todosProductosNuevos.filter(p => p.disponible !== false);
            
            if (productosDisponiblesCliente.length > 0) {
                containerEspecialCliente.style.display = 'block';
                containerEspecialCliente.innerHTML = `
                    <div class="nuevos-especial-container">
                        <div class="nuevos-especial-title">
                            <i class="fas fa-star"></i>
                            <span>游 춰NUEVOS PRODUCTOS! 游</span>
                            <i class="fas fa-star"></i>
                        </div>
                        <p style="text-align: center; color: #92400e; margin-bottom: 16px; font-weight: bold;">
                            游꿁 춰Reci칠n llegados! Oferta especial por tiempo limitado 游꿁
                        </p>
                        <div class="productos-list">
                            ${productosDisponiblesCliente.map(producto => {
                                return `
                                    <div class="nuevos-especial-producto">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                            <h4 style="font-size: 1.1rem; font-weight: bold;">
                                                ${producto.nombre}
                                                <span class="producto-nuevo-tag">NUEVO</span>
                                            </h4>
                                            <span style="font-size: 1.2rem; color: var(--primary); font-weight: bold;">
                                                $${producto.precio}
                                            </span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: var(--secondary);">
                                            ${producto.presentacion ? `<div><strong>游닍:</strong> ${producto.presentacion}</div>` : ''}
                                            <span class="categoria-badge categoria-${producto.categoria}" style="margin-top: 8px;">
                                                ${obtenerEmojiCategoria(producto.categoria)} ${producto.categoria}
                                            </span>
                                        </div>
                                        <div style="margin-top: 12px; text-align: center;">
                                            <button class="btn" onclick="abrirModalPedido()" style="background: var(--primary); color: white; padding: 8px 16px; font-size: 0.9rem; width: 100%;">
                                                <i class="fas fa-cart-plus"></i> Pedir este producto
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="text-align: center; margin-top: 16px; color: #92400e; font-size: 0.9rem; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                            <i class="fas fa-bolt"></i> 춰Oferta por tiempo limitado! Estos productos son novedad
                        </div>
                    </div>
                `;
            } else {
                containerEspecialCliente.style.display = 'none';
            }
            
            // ========== SECCI칍N NORMAL DE PRODUCTOS NUEVOS (para compatibilidad) ==========
            
            // Para usuarios logueados (versi칩n normal)
            const containerUsuario = document.getElementById('nuevos-productos-usuario');
            if (todosProductosNuevos.length > 0) {
                containerUsuario.style.display = 'block';
                containerUsuario.innerHTML = `
                    <div class="nuevos-container">
                        <div class="nuevos-title">
                            <i class="fas fa-star"></i>
                            <span>Productos Nuevos</span>
                        </div>
                        <div class="productos-list">
                            ${todosProductosNuevos.map(producto => `
                                <div class="producto-card">
                                    <div class="producto-info">
                                        <h4>
                                            ${producto.nombre}
                                            <span class="producto-nuevo-tag">NUEVO</span>
                                        </h4>
                                        <div style="font-size: 0.8rem; color: var(--secondary);">
                                            <div>Tu precio: $${producto.precio}</div>
                                            <div>Precio proveedora: $${producto.precioVentaElla || producto.precio}</div>
                                            ${usuarioLogueado ? `<div style="color: #10b981;">Costo: $${producto.precioCosto || 0}</div>` : ''}
                                            ${producto.presentacion ? `  ${producto.presentacion}` : ''}
                                            <span class="categoria-badge categoria-${producto.categoria}">
                                                ${producto.categoria}
                                            </span>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="disponibilidad-badge ${producto.disponible !== false ? 'disponible' : 'no-disponible'}" 
                                              onclick="toggleDisponibilidadProducto(${producto.id}, ${listadoSeleccionado ? listadoSeleccionado.id : 'null'})">
                                            <i class="fas fa-${producto.disponible !== false ? 'check' : 'times'}"></i>
                                            ${producto.disponible !== false ? 'Disponible' : 'No disponible'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                containerUsuario.style.display = 'none';
            }
        }

        // Funci칩n auxiliar para agregar producto a pedido directamente
        function agregarProductoAPedido(productoId) {
            // Buscar el producto
            let productoEncontrado = null;
            let listadoEncontrado = null;
            
            for (let listado of listados) {
                if (listado.productos) {
                    productoEncontrado = listado.productos.find(p => p.id === productoId);
                    if (productoEncontrado) {
                        listadoEncontrado = listado;
                        break;
                    }
                }
            }
            
            if (!productoEncontrado) {
                alert('Producto no encontrado');
                return;
            }
            
            // Verificar si ya est치 seleccionado
            const index = productosSeleccionados.findIndex(p => p.id === productoId);
            if (index !== -1) {
                productosSeleccionados[index].cantidad += 1;
            } else {
                productosSeleccionados.push({
                    ...productoEncontrado,
                    cantidad: 1,
                    precioVentaElla: productoEncontrado.precioVentaElla || productoEncontrado.precio
                });
            }
            
            actualizarListaProductosSeleccionados();
            alert(`"${productoEncontrado.nombre}" agregado al pedido`);
        }

        // ================ SISTEMA DE COMPARTIR LISTADOS CON PRODUCTOS NUEVOS ESPECIAL ================
        function compartirListadoNuevosEspecial() {
            if (!listadoSeleccionado || !listadoSeleccionado.productos || listadoSeleccionado.productos.length === 0) {
                alert('El listado est치 vac칤o');
                return;
            }
            
            // Filtrar solo productos nuevos (menos de 1 semana y disponibles)
            const unaSemanaAtras = new Date();
            unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
            
            const productosNuevos = listadoSeleccionado.productos.filter(p => {
                if (!p.fechaCreacion) return false;
                if (p.disponible === false) return false;
                
                const fechaCreacion = new Date(p.fechaCreacion);
                return fechaCreacion >= unaSemanaAtras;
            });
            
            if (productosNuevos.length === 0) {
                alert('No hay productos nuevos en este listado');
                return;
            }
            
            // Preparar contenido especial para compartir
            const contenido = generarContenidoNuevosEspecial(productosNuevos);
            
            document.getElementById('fechaActualizacion').textContent = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('contenidoParaCompartir').textContent = contenido;
            document.getElementById('modalCompartirListado').style.display = 'flex';
        }

        function generarContenidoNuevosEspecial(productos) {
            let contenido = '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n';
            contenido += '游 *춰NUEVOS PRODUCTOS ESPECIALES!* 游륲n';
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n\n';
            contenido += '춰HOLA AMIGOS! 游녦\n\n';
            contenido += '游꿁 *춰TENEMOS NOVEDADES!* 游꿁\n\n';
            contenido += 'Estos productos son *NUEVOS* y estar치n disponibles por tiempo limitado:\n\n';
            
            // Ordenar por categor칤a
            const productosPorCategoria = {};
            productos.forEach(producto => {
                if (!productosPorCategoria[producto.categoria]) {
                    productosPorCategoria[producto.categoria] = [];
                }
                productosPorCategoria[producto.categoria].push(producto);
            });
            
            // Ordenar categor칤as
            const categoriasOrden = ['medicamento', 'inyecciones', 'cremas', 'ovulos', 'suspension', 'operaciones', 'lacteos', 'colirio', 'otros'];
            
            categoriasOrden.forEach(categoria => {
                if (productosPorCategoria[categoria]) {
                    // Ordenar productos alfab칠ticamente
                    productosPorCategoria[categoria].sort((a, b) => a.nombre.localeCompare(b.nombre));
                    
                    contenido += obtenerNombreCategoriaCompartir(categoria) + '\n';
                    
                    productosPorCategoria[categoria].forEach(producto => {
                        const emoji = obtenerEmojiCategoria(categoria);
                        contenido += `${emoji} *${producto.nombre}*`;
                        
                        if (producto.presentacion) {
                            contenido += ` (${producto.presentacion})`;
                        }
                        
                        contenido += ` .................... $${producto.precio}\n`;
                    });
                    
                    contenido += '\n';
                }
            });
            
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n';
            contenido += '游꿢 *OFERTA ESPECIAL POR SER NUEVOS*\n';
            contenido += '낋 *Disponible solo esta semana*\n';
            contenido += '游뚴 *DOMICILIOS A $150* 游눯\n';
            contenido += '游 춰Ll치manos para hacer tu pedido!\n';
            contenido += '九 춰No te quedes sin tus nuevos productos! 九\n';
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷';
            
            return contenido;
        }

        // ================ SISTEMA DE COMPARTIR LISTADOS ================
        function compartirListadoActual() {
            if (!listadoSeleccionado || !listadoSeleccionado.productos || listadoSeleccionado.productos.length === 0) {
                alert('El listado est치 vac칤o');
                return;
            }
            
            // Preparar contenido para compartir
            const productosDisponibles = listadoSeleccionado.productos.filter(p => p.disponible !== false);
            const contenido = generarContenidoParaCompartir(productosDisponibles);
            
            document.getElementById('fechaActualizacion').textContent = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('contenidoParaCompartir').textContent = contenido;
            document.getElementById('modalCompartirListado').style.display = 'flex';
        }

        function generarContenidoParaCompartir(productos) {
            let contenido = '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n';
            contenido += '游낀 *LISTA DE PRODUCTOS ACTUALIZADA* 游낀\n';
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n\n';
            contenido += '춰Hola amigos! 游녦\n\n';
            contenido += '游늰 *Actualizado:* ' + new Date().toLocaleDateString('es-ES') + '\n\n';
            contenido += 'Aqu칤 tienen nuestra lista completa:\n\n';
            
            // Agrupar productos por categor칤a
            const productosPorCategoria = {};
            productos.forEach(producto => {
                if (!productosPorCategoria[producto.categoria]) {
                    productosPorCategoria[producto.categoria] = [];
                }
                productosPorCategoria[producto.categoria].push(producto);
            });
            
            // Ordenar categor칤as
            const categoriasOrden = ['medicamento', 'inyecciones', 'cremas', 'ovulos', 'suspension', 'operaciones', 'lacteos', 'colirio', 'otros'];
            
            categoriasOrden.forEach(categoria => {
                if (productosPorCategoria[categoria]) {
                    // Ordenar productos alfab칠ticamente
                    productosPorCategoria[categoria].sort((a, b) => a.nombre.localeCompare(b.nombre));
                    
                    contenido += obtenerNombreCategoriaCompartir(categoria) + '\n';
                    
                    productosPorCategoria[categoria].forEach(producto => {
                        const emoji = obtenerEmojiCategoria(categoria);
                        contenido += `${emoji} *${producto.nombre}*`;
                        
                        if (producto.presentacion) {
                            contenido += ` (${producto.presentacion})`;
                        }
                        
                        contenido += ` .................... $${producto.precio}\n`;
                    });
                    
                    contenido += '\n';
                }
            });
            
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷\n';
            contenido += '游뚴 *DOMICILIOS A $150* 游눯\n';
            contenido += '游 춰Ll치manos para hacer tu pedido!\n';
            contenido += '九 춰Gracias por tu preferencia! 九\n';
            contenido += '轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷轎넉뎷';
            
            return contenido;
        }

        function cerrarModalCompartirListado() {
            document.getElementById('modalCompartirListado').style.display = 'none';
        }

        function copiarLista() {
            const contenido = document.getElementById('contenidoParaCompartir').textContent;
            
            navigator.clipboard.writeText(contenido)
                .then(() => {
                    alert('춰Lista copiada al portapapeles! 游늶');
                })
                .catch(err => {
                    console.error('Error al copiar: ', err);
                    alert('Error al copiar. Intenta de nuevo.');
                });
        }

        function compartirListaWhatsApp() {
            const contenido = document.getElementById('contenidoParaCompartir').textContent;
            const mensajeCodificado = encodeURIComponent(contenido);
            const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
            
            window.open(urlWhatsApp, '_blank');
        }

        // ================ SISTEMA DE DISPONIBILIDAD ================
        function toggleDisponibilidadProducto(productoId, listadoId) {
            const listado = listados.find(l => l.id === listadoId);
            if (!listado || !listado.productos) return;
            
            const producto = listado.productos.find(p => p.id === productoId);
            if (!producto) return;
            
            // Cambiar disponibilidad
            producto.disponible = !producto.disponible;
            
            // Actualizar en todos los listados (si el producto est치 en m칰ltiples listados)
            listados.forEach(l => {
                if (l.productos) {
                    const prodEnListado = l.productos.find(p => p.id === productoId);
                    if (prodEnListado) {
                        prodEnListado.disponible = producto.disponible;
                    }
                }
            });
            
            guardarEnLocalStorage();
            
            // Si el producto se marca como no disponible, lo quitamos de productos nuevos
            if (producto.disponible === false) {
                cargarProductosNuevos();
            }
            
            if (listadoSeleccionado && listadoSeleccionado.id === listadoId) {
                cargarProductosListado();
            }
            
            // Mostrar notificaci칩n
            const estado = producto.disponible ? 'disponible 九' : 'no disponible 仇';
            console.log(`Producto "${producto.nombre}" marcado como ${estado}`);
        }

        // ================ GESTI칍N DE BACKUPS ================
        function cargarListaBackups() {
            const container = document.getElementById('lista-backups');
            
            if (backups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <h3>No hay backups</h3>
                        <p>Los backups autom치ticos aparecer치n aqu칤</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = backups.map(backup => `
                <div class="backup-item">
                    <div class="backup-info">
                        <strong>${new Date(backup.fecha).toLocaleString()}</strong>
                        <div style="font-size: 0.8rem; color: var(--secondary);">
                            ${backup.automatico ? '游댃 Autom치tico' : '游 Manual'}  ${backup.datos.pedidos ? backup.datos.pedidos.length : 0} pedidos
                        </div>
                    </div>
                    <div class="backup-actions">
                        <button class="btn" onclick="restaurarBackup(${backup.id})" style="background: var(--primary); color: white; padding: 8px;">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn" onclick="eliminarBackup(${backup.id})" style="background: var(--danger); color: white; padding: 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Actualizar 칰ltimo backup en la UI
            if (config.ultimoBackup) {
                document.getElementById('ultimoBackup').textContent = new Date(config.ultimoBackup).toLocaleString();
            }
        }

        function restaurarBackup(backupId) {
            const backup = backups.find(b => b.id === backupId);
            if (!backup) return;
            
            if (confirm('Restaurar este backup? Se reemplazar치n los datos actuales.')) {
                pedidos = backup.datos.pedidos || [];
                listados = backup.datos.listados || [];
                usuarios = backup.datos.usuarios || [];
                notificaciones = backup.datos.notificaciones || [];
                
                // Actualizar configuraci칩n
                config.ultimoBackup = backup.fecha;
                
                guardarEnLocalStorage();
                cargarPedidosPendientes();
                cargarListaListados();
                cargarHistorial();
                cargarProductosNuevos();
                alert('Backup restaurado exitosamente!');
            }
        }

        function eliminarBackup(backupId) {
            if (confirm('쮼liminar este backup?')) {
                backups = backups.filter(b => b.id !== backupId);
                localStorage.setItem('backups', JSON.stringify(backups));
                cargarListaBackups();
            }
        }

        function exportarBackup() {
            const data = {
                pedidos: pedidos,
                listados: listados,
                usuarios: usuarios,
                notificaciones: notificaciones,
                fechaBackup: new Date().toISOString(),
                version: '6.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = config.backupFile; // Usar el mismo archivo siempre
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Guardar info del backup
            const backupInfo = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                datos: data,
                automatico: false
            };
            
            backups.unshift(backupInfo);
            config.ultimoBackup = new Date().toISOString();
            guardarEnLocalStorage();
            
            alert('Backup exportado exitosamente!');
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('쮼st치s seguro de importar este backup? Se reemplazar치n todos los datos actuales.')) {
                        pedidos = data.pedidos || [];
                        listados = data.listados || [];
                        usuarios = data.usuarios || [];
                        notificaciones = data.notificaciones || [];
                        
                        // Actualizar configuraci칩n
                        config.ultimoBackup = new Date().toISOString();
                        
                        // Guardar como backup
                        const backupInfo = {
                            id: Date.now(),
                            fecha: new Date().toISOString(),
                            datos: data,
                            automatico: false
                        };
                        
                        backups.unshift(backupInfo);
                        guardarEnLocalStorage();
                        
                        cargarPedidosPendientes();
                        cargarListaListados();
                        cargarHistorial();
                        cargarProductosNuevos();
                        alert('Backup importado exitosamente!');
                    }
                } catch (error) {
                    alert('Error al importar el backup: Archivo inv치lido');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ================ ESTAD칈STICAS MEJORADAS ================
        function mostrarEstadisticas(pedidosFiltrados, periodo) {
            const container = document.getElementById('estadisticas-contenido');
            const detallesContainer = document.getElementById('detalles-estadisticas');
            
            if (pedidosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <h3>No hay datos para mostrar</h3>
                        <p>No hay pedidos completados en el per칤odo seleccionado</p>
                    </div>
                `;
                detallesContainer.innerHTML = '';
                return;
            }
            
            // Calcular estad칤sticas b치sicas
            const totalVentas = pedidosFiltrados.reduce((sum, p) => sum + calcularTotalPedido(p), 0);
            const promedioVenta = totalVentas / pedidosFiltrados.length;
            const totalProductos = pedidosFiltrados.reduce((sum, p) => sum + p.productos.reduce((sumProd, prod) => sumProd + prod.cantidad, 0), 0);
            
            // Calcular costo total y ganancias
            let totalCosto = 0;
            let gananciaTotal = 0;
            let gananciaDomicilio = 0;
            let costoProductos = 0;
            
            // Contar pedidos por tipo
            let pedidosYo = 0;
            let pedidosProveedora = 0;
            
            pedidosFiltrados.forEach(pedido => {
                const costoPedido = pedido.productos.reduce((sum, productoPedido) => {
                    const productoOriginal = buscarProductoOriginal(productoPedido.id);
                    if (productoOriginal && productoOriginal.precioCosto) {
                        return sum + (productoOriginal.precioCosto * productoPedido.cantidad);
                    }
                    return sum;
                }, 0);
                
                totalCosto += costoPedido;
                costoProductos += costoPedido;
                gananciaTotal += calcularTotalPedido(pedido) - costoPedido;
                gananciaDomicilio += pedido.precioDomicilio || 0;
                
                // Contar por tipo
                if (pedido.quienConsiguio === 'proveedora') {
                    pedidosProveedora++;
                } else {
                    pedidosYo++;
                }
            });
            
            // Calcular m치rgenes
            const margenGanancia = totalVentas > 0 ? ((gananciaTotal / totalVentas) * 100) : 0;
            const costoPromedio = pedidosFiltrados.length > 0 ? (totalCosto / pedidosFiltrados.length) : 0;
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${pedidosFiltrados.length}</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${totalVentas.toLocaleString()}</div>
                    <div class="stat-label">Total Ventas</div>
                </div>
                <div class="stat-card" style="background: #fef2f2;">
                    <div class="stat-value" style="color: #dc2626;">$${totalCosto.toLocaleString()}</div>
                    <div class="stat-label">Costo Total</div>
                </div>
                <div class="stat-card" style="background: #f0fdf4;">
                    <div class="stat-value" style="color: #10b981;">$${gananciaTotal.toLocaleString()}</div>
                    <div class="stat-label">Ganancia Neta</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${margenGanancia.toFixed(1)}%</div>
                    <div class="stat-label">Margen Ganancia</div>
                </div>
                <div class="stat-card" style="background: #f0f9ff;">
                    <div class="stat-value" style="color: #0369a1;">${pedidosYo}</div>
                    <div class="stat-label">Pedidos Tuyos</div>
                </div>
                <div class="stat-card" style="background: #f5f3ff;">
                    <div class="stat-value" style="color: #8B5CF6;">${pedidosProveedora}</div>
                    <div class="stat-label">Pedidos Proveedora</div>
                </div>
            `;
            
            container.innerHTML = statsHTML;
            
            let detallesHTML = `
                <div class="pedido-detalle">
                    <div class="detalle-item">
                        <span class="detalle-label">Costo Promedio por Pedido:</span>
                        <span class="detalle-value">$${costoPromedio.toFixed(2)}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Ganancia Promedio por Pedido:</span>
                        <span class="detalle-value" style="color: #10b981;">$${(gananciaTotal / pedidosFiltrados.length).toFixed(2)}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Total a Pagar (Costos):</span>
                        <span class="detalle-value" style="color: #dc2626; font-weight: bold;">$${totalCosto.toLocaleString()}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Total a Recibir (Ganancias):</span>
                        <span class="detalle-value" style="color: #10b981; font-weight: bold;">$${gananciaTotal.toLocaleString()}</span>
                    </div>
                </div>
            `;
            
            // Productos m치s vendidos con costos
            const productosVendidos = {};
            pedidosFiltrados.forEach(pedido => {
                pedido.productos.forEach(producto => {
                    if (!productosVendidos[producto.nombre]) {
                        productosVendidos[producto.nombre] = {
                            cantidad: 0,
                            ventas: 0,
                            costo: 0,
                            ganancia: 0
                        };
                    }
                    productosVendidos[producto.nombre].cantidad += producto.cantidad;
                    productosVendidos[producto.nombre].ventas += producto.precio * producto.cantidad;
                    
                    const productoOriginal = buscarProductoOriginal(producto.id);
                    if (productoOriginal && productoOriginal.precioCosto) {
                        const costoProducto = productoOriginal.precioCosto * producto.cantidad;
                        productosVendidos[producto.nombre].costo += costoProducto;
                        productosVendidos[producto.nombre].ganancia += (producto.precio * producto.cantidad) - costoProducto;
                    }
                });
            });
            
            const productosTop = Object.entries(productosVendidos)
                .sort((a, b) => b[1].cantidad - a[1].cantidad)
                .slice(0, 5);
            
            if (productosTop.length > 0) {
                detallesHTML += `
                    <h3 style="margin-top: 24px;">Productos M치s Vendidos (con costos)</h3>
                    <div class="productos-list">
                        ${productosTop.map(([producto, datos]) => `
                            <div class="producto-item">
                                <div>
                                    <strong>${producto}</strong>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">
                                        ${datos.cantidad} unidades  Ventas: $${datos.ventas}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #dc2626; font-size: 0.9rem;">Costo: $${datos.costo}</div>
                                    <div style="color: #10b981; font-weight: bold;">Ganancia: $${datos.ganancia}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            detallesContainer.innerHTML = detallesHTML;
        }

        // ================ FUNCIONES ORIGINALES (MODIFICADAS PARA LAS MEJORAS) ================
        
        // Sistema de Autenticaci칩n
        function inicializarBaseDeDatos() {
            // Agregar usuario administrador si no existe
            const adminExiste = usuarios.some(u => u.usuario === ADMIN_USER.usuario);
            if (!adminExiste) {
                usuarios.push(ADMIN_USER);
                guardarEnLocalStorage();
            }
            
            // Inicializar backups si no existen
            if (!config.ultimoBackup) {
                config.ultimoBackup = new Date().toISOString();
                guardarEnLocalStorage();
            }
        }

        function cargarVistaSegunLogin() {
            const userSection = document.getElementById('userSection');
            const clienteView = document.getElementById('clienteView');
            const usuarioView = document.getElementById('usuarioView');
            
            if (usuarioLogueado) {
                // Usuario logueado
                userSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">
                            ${usuarioLogueado.usuario.charAt(0).toUpperCase()}
                        </div>
                        <span>${usuarioLogueado.usuario}</span>
                        <button class="login-btn" onclick="cerrarSesion()" style="margin-left: 8px;">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                `;
                clienteView.style.display = 'none';
                usuarioView.style.display = 'block';
                
                // Mostrar gesti칩n de usuarios solo para admin
                if (usuarioLogueado.rol === 'admin') {
                    document.getElementById('gestionUsuariosSection').style.display = 'block';
                    cargarListaUsuarios();
                }
            } else {
                // Cliente sin login
                userSection.innerHTML = `
                    <button class="login-btn" onclick="abrirModalLogin()">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesi칩n
                    </button>
                `;
                clienteView.style.display = 'block';
                usuarioView.style.display = 'none';
                cargarProductosParaClientes();
            }
        }

        function abrirModalLogin() {
            document.getElementById('modalLogin').style.display = 'flex';
        }

        function cerrarModalLogin() {
            document.getElementById('modalLogin').style.display = 'none';
        }

        function iniciarSesion(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('loginUsuario').value;
            const password = document.getElementById('loginPassword').value;
            
            const usuarioEncontrado = usuarios.find(u => 
                u.usuario === usuario && u.password === password
            );
            
            if (usuarioEncontrado) {
                usuarioLogueado = usuarioEncontrado;
                localStorage.setItem('usuarioLogueado', JSON.stringify(usuarioLogueado));
                cargarVistaSegunLogin();
                cerrarModalLogin();
                cargarProductosNuevos();
            } else {
                alert('Usuario o contrase침a incorrectos');
            }
        }

        function cerrarSesion() {
            usuarioLogueado = null;
            localStorage.removeItem('usuarioLogueado');
            cargarVistaSegunLogin();
        }

        function abrirModalNuevoUsuario() {
            if (usuarioLogueado && usuarioLogueado.rol === 'admin') {
                document.getElementById('modalNuevoUsuario').style.display = 'flex';
            }
        }

        function cerrarModalNuevoUsuario() {
            document.getElementById('modalNuevoUsuario').style.display = 'none';
        }

        function crearNuevoUsuario(event) {
            event.preventDefault();
            
            const nuevoUsuario = {
                usuario: document.getElementById('nuevoUsuario').value,
                telefono: document.getElementById('nuevoTelefono').value,
                password: document.getElementById('nuevoPassword').value,
                rol: 'vendedor',
                fechaCreacion: new Date().toISOString()
            };
            
            // Verificar si el usuario ya existe
            const usuarioExiste = usuarios.some(u => u.usuario === nuevoUsuario.usuario);
            if (usuarioExiste) {
                alert('El usuario ya existe');
                return;
            }
            
            usuarios.push(nuevoUsuario);
            guardarEnLocalStorage();
            cargarListaUsuarios();
            cerrarModalNuevoUsuario();
            document.getElementById('formNuevoUsuario').reset();
            
            alert('Usuario creado exitosamente');
        }

        function cargarListaUsuarios() {
            const container = document.getElementById('lista-usuarios');
            const usuariosVendedores = usuarios.filter(u => u.rol === 'vendedor');
            
            if (usuariosVendedores.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No hay vendedores</h3>
                        <p>Crea el primer usuario vendedor</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = usuariosVendedores.map(usuario => `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <div class="cliente-info">
                            <h3>${usuario.usuario}</h3>
                            <div class="telefono">${usuario.telefono}</div>
                            <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                                Creado: ${new Date(usuario.fechaCreacion).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="pedido-actions">
                            <button class="btn btn-danger" onclick="eliminarUsuario('${usuario.usuario}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function eliminarUsuario(usuario) {
            if (confirm(`쮼st치s seguro de eliminar al usuario ${usuario}?`)) {
                usuarios = usuarios.filter(u => u.usuario !== usuario);
                guardarEnLocalStorage();
                cargarListaUsuarios();
            }
        }

        // Sistema de Notificaciones
        function iniciarSistemaNotificaciones() {
            // Verificar notificaciones cada minuto
            intervaloNotificaciones = setInterval(verificarNotificaciones, 60000);
            verificarNotificaciones(); // Verificar inmediatamente al cargar
        }

        function verificarNotificaciones() {
            if (!usuarioLogueado) return;
            
            const ahora = new Date();
            const pedidosPendientes = pedidos.filter(p => !p.completado);
            let nuevasNotificaciones = [];
            
            pedidosPendientes.forEach(pedido => {
                const fechaPedido = new Date(pedido.fecha);
                const diferenciaHoras = (ahora - fechaPedido) / (1000 * 60 * 60);
                
                if (diferenciaHoras >= 1) {
                    // Verificar si ya hay una notificaci칩n reciente para este pedido
                    const notificacionReciente = notificaciones.find(n => 
                        n.pedidoId === pedido.id && 
                        (ahora - new Date(n.fecha)) < (1000 * 60 * 60) // Menos de 1 hora
                    );
                    
                    if (!notificacionReciente) {
                        nuevasNotificaciones.push({
                            id: Date.now(),
                            pedidoId: pedido.id,
                            mensaje: `Pedido pendiente por m치s de 1 hora: ${pedido.nombreCliente || 'Cliente'} - ${pedido.telefono}`,
                            fecha: new Date().toISOString(),
                            leida: false
                        });
                    }
                }
            });
            
            if (nuevasNotificaciones.length > 0) {
                notificaciones.push(...nuevasNotificaciones);
                guardarEnLocalStorage();
                mostrarNotificaciones();
                
                // Mostrar alerta solo si el usuario est치 en la app
                if (document.visibilityState === 'visible') {
                    alert(`Tienes ${nuevasNotificaciones.length} pedido(s) pendiente(s) por m치s de 1 hora`);
                }
            }
        }

        function mostrarNotificaciones() {
            if (!usuarioLogueado) return;
            
            const notificacionesNoLeidas = notificaciones.filter(n => !n.leida);
            const badge = document.querySelector('.notification-badge');
            
            if (notificacionesNoLeidas.length > 0) {
                // Aqu칤 podr칤as agregar un badge de notificaciones en el header
                console.log(`Tienes ${notificacionesNoLeidas.length} notificaciones pendientes`);
            }
        }

        // Funciones de Navegaci칩n
        function cambiarTab(tabName) {
            if (!usuarioLogueado) return;
            
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Actualizar tabs activos
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Cargar contenido espec칤fico
            if (tabName === 'pendientes') {
                cargarPedidosPendientes();
            } else if (tabName === 'historial') {
                cargarHistorial();
            } else if (tabName === 'estadisticas') {
                cargarEstadisticas();
            } else if (tabName === 'listados') {
                cargarListaListados();
                cargarProductosNuevos();
            } else if (tabName === 'configuracion') {
                actualizarEstadisticas();
                cargarListaBackups();
            }
        }

        // Funciones de Listados
        function cargarListadosIniciales() {
            if (listados.length === 0) {
                listados = [
                    { 
                        id: 1, 
                        nombre: "Medicamentos", 
                        productos: [] 
                    }
                ];
                guardarEnLocalStorage();
            }
        }

        function cargarListaListados() {
            const container = document.getElementById('lista-listados');
            
            if (listados.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-list"></i>
                        <h3>No hay listados</h3>
                        <p>Crea tu primer listado para organizar tus productos</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = listados.map(listado => `
                <div class="listado-card" onclick="abrirModalGestionListado(${listado.id})">
                    <div class="listado-header">
                        <h3>${listado.nombre}</h3>
                        <div class="pedido-actions">
                            <button class="btn btn-edit" onclick="event.stopPropagation(); editarListado(${listado.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); eliminarListado(${listado.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="listado-count">
                        ${listado.productos ? listado.productos.length : 0} productos
                        <button class="btn-share-list" onclick="event.stopPropagation(); compartirListado(${listado.id})">
                            <i class="fas fa-share-alt"></i> Compartir
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function compartirListado(listadoId) {
            listadoSeleccionado = listados.find(l => l.id === listadoId);
            if (!listadoSeleccionado) return;
            
            compartirListadoActual();
        }

        function abrirModalNuevoListado() {
            listadoEditando = null;
            document.getElementById('modalListadoTitulo').textContent = 'Nuevo Listado';
            document.getElementById('formListado').reset();
            document.getElementById('modalNuevoListado').style.display = 'flex';
        }

        function cerrarModalNuevoListado() {
            document.getElementById('modalNuevoListado').style.display = 'none';
        }

        function guardarListado(event) {
            event.preventDefault();
            
            const listado = {
                id: listadoEditando ? listadoEditando.id : Date.now(),
                nombre: document.getElementById('nombreListado').value,
                productos: listadoEditando ? listadoEditando.productos : []
            };
            
            if (listadoEditando) {
                // Actualizar listado existente
                const index = listados.findIndex(l => l.id === listadoEditando.id);
                listados[index] = listado;
            } else {
                // Agregar nuevo listado
                listados.push(listado);
            }
            
            guardarEnLocalStorage();
            cargarListaListados();
            cerrarModalNuevoListado();
            
            alert('Listado guardado exitosamente!');
        }

        function editarListado(id) {
            listadoEditando = listados.find(l => l.id === id);
            if (!listadoEditando) return;
            
            document.getElementById('modalListadoTitulo').textContent = 'Editar Listado';
            document.getElementById('listadoId').value = listadoEditando.id;
            document.getElementById('nombreListado').value = listadoEditando.nombre;
            
            document.getElementById('modalNuevoListado').style.display = 'flex';
        }

        function eliminarListado(id) {
            if (confirm('쮼st치s seguro de eliminar este listado?')) {
                listados = listados.filter(l => l.id !== id);
                guardarEnLocalStorage();
                cargarListaListados();
                cargarProductosNuevos();
            }
        }

        function abrirModalGestionListado(id) {
            listadoSeleccionado = listados.find(l => l.id === id);
            if (!listadoSeleccionado) return;
            
            document.getElementById('modalGestionTitulo').textContent = `Gestionar: ${listadoSeleccionado.nombre}`;
            cargarProductosListado();
            document.getElementById('modalGestionListado').style.display = 'flex';
        }

        function cerrarModalGestionListado() {
            document.getElementById('modalGestionListado').style.display = 'none';
        }

        function cargarProductosListado() {
            const container = document.getElementById('productos-listado');
            const productos = listadoSeleccionado.productos || [];
            
            if (productos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No hay productos</h3>
                        <p>Agrega productos a este listado</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar productos por categor칤a y alfab칠ticamente
            const productosOrdenados = ordenarProductosPorCategoria(productos);
            
            container.innerHTML = productosOrdenados.map(grupo => `
                <div style="margin: 16px 0;">
                    <h3 style="padding: 8px 12px; background: #e2e8f0; border-radius: 8px; font-size: 0.9rem;">
                        ${obtenerNombreCategoria(grupo.categoria)} (${grupo.productos.length})
                    </h3>
                    ${grupo.productos.map(producto => {
                        // MEJORA: Calcular si es nuevo (menos de 1 semana y disponible)
                        const unaSemanaAtras = new Date();
                        unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
                        
                        const esNuevo = producto.fechaCreacion ? 
                            (new Date(producto.fechaCreacion) >= unaSemanaAtras && producto.disponible !== false) : false;
                        
                        return `
                            <div class="producto-card">
                                <div class="producto-info">
                                    <h4>
                                        ${producto.nombre}
                                        ${esNuevo ? '<span class="producto-nuevo-tag">NUEVO</span>' : ''}
                                    </h4>
                                    <div style="font-size: 0.8rem; color: var(--secondary);">
                                        <div>Tu precio: $${producto.precio}</div>
                                        <div>Precio proveedora: $${producto.precioVentaElla || producto.precio}</div>
                                        ${usuarioLogueado ? `<div style="color: #10b981;">Costo: $${producto.precioCosto || 0}</div>` : ''}
                                        ${producto.presentacion ? `  ${producto.presentacion}` : ''}
                                        <span class="categoria-badge categoria-${producto.categoria}">
                                            ${producto.categoria}
                                        </span>
                                    </div>
                                </div>
                                <div class="pedido-actions">
                                    <span class="disponibilidad-badge ${producto.disponible !== false ? 'disponible' : 'no-disponible'}" 
                                          onclick="toggleDisponibilidadProducto(${producto.id}, ${listadoSeleccionado.id})">
                                        <i class="fas fa-${producto.disponible !== false ? 'check' : 'times'}"></i>
                                    </span>
                                    <button class="btn btn-edit" onclick="editarProducto(${producto.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="eliminarProducto(${producto.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        // Funciones de Productos
        function abrirModalNuevoProducto() {
            productoEditando = null;
            document.getElementById('modalProductoTitulo').textContent = 'Nuevo Producto';
            document.getElementById('formProducto').reset();
            document.getElementById('productoDisponible').checked = true;
            document.getElementById('modalNuevoProducto').style.display = 'flex';
        }

        function cerrarModalNuevoProducto() {
            document.getElementById('modalNuevoProducto').style.display = 'none';
        }

        function guardarProducto(event) {
            event.preventDefault();
            
            const producto = {
                id: productoEditando ? productoEditando.id : Date.now(),
                nombre: document.getElementById('nombreProducto').value,
                precio: parseInt(document.getElementById('precioProducto').value),
                precioCosto: parseInt(document.getElementById('precioCostoProducto').value),
                precioVentaElla: parseInt(document.getElementById('precioVentaEllaProducto').value),
                categoria: document.getElementById('categoriaProducto').value,
                presentacion: document.getElementById('presentacionProducto').value || '',
                disponible: document.getElementById('productoDisponible').checked,
                // MEJORA: Solo establecer fechaCreacion si es un producto NUEVO
                fechaCreacion: productoEditando ? productoEditando.fechaCreacion : new Date().toISOString()
            };
            
            if (productoEditando) {
                // MEJORA: Al editar, NO cambiamos la fechaCreacion
                // Solo actualizamos los otros campos
                
                // Actualizar producto existente en todos los listados
                listados.forEach(listado => {
                    const index = listado.productos.findIndex(p => p.id === productoEditando.id);
                    if (index !== -1) {
                        // Mantener la fechaCreacion original
                        producto.fechaCreacion = listado.productos[index].fechaCreacion;
                        listado.productos[index] = producto;
                    }
                });
            } else {
                // Agregar nuevo producto al listado seleccionado
                if (listadoSeleccionado) {
                    if (!listadoSeleccionado.productos) {
                        listadoSeleccionado.productos = [];
                    }
                    listadoSeleccionado.productos.push(producto);
                }
            }
            
            guardarEnLocalStorage();
            
            if (listadoSeleccionado) {
                cargarProductosListado();
            }
            
            cerrarModalNuevoProducto();
            
            // Actualizar productos nuevos
            cargarProductosNuevos();
            
            alert('Producto guardado exitosamente!');
        }

        function editarProducto(id) {
            // Buscar el producto en todos los listados
            for (let listado of listados) {
                productoEditando = listado.productos.find(p => p.id === id);
                if (productoEditando) break;
            }
            
            if (!productoEditando) return;
            
            document.getElementById('modalProductoTitulo').textContent = 'Editar Producto';
            document.getElementById('productoId').value = productoEditando.id;
            document.getElementById('nombreProducto').value = productoEditando.nombre;
            document.getElementById('precioProducto').value = productoEditando.precio;
            document.getElementById('precioCostoProducto').value = productoEditando.precioCosto || 0;
            document.getElementById('precioVentaEllaProducto').value = productoEditando.precioVentaElla || productoEditando.precio;
            document.getElementById('categoriaProducto').value = productoEditando.categoria;
            document.getElementById('presentacionProducto').value = productoEditando.presentacion || '';
            document.getElementById('productoDisponible').checked = productoEditando.disponible !== false;
            
            document.getElementById('modalNuevoProducto').style.display = 'flex';
        }

        function eliminarProducto(id) {
            if (confirm('쮼st치s seguro de eliminar este producto?')) {
                // Eliminar producto de todos los listados
                listados.forEach(listado => {
                    listado.productos = listado.productos.filter(p => p.id !== id);
                });
                guardarEnLocalStorage();
                if (listadoSeleccionado) {
                    cargarProductosListado();
                }
                cargarProductosNuevos();
            }
        }

        // Funci칩n para buscar un producto original por ID
        function buscarProductoOriginal(productoId) {
            for (let listado of listados) {
                if (listado.productos) {
                    const producto = listado.productos.find(p => p.id === productoId);
                    if (producto) return producto;
                }
            }
            return null;
        }

        // ANALIZADOR INTELIGENTE MEJORADO
        function procesarListaProductos() {
            const texto = document.getElementById('listaProductosTexto').value;
            const listadoDestinoId = document.getElementById('listadoDestino').value;
            
            if (!listadoDestinoId) {
                alert('Por favor selecciona un listado destino');
                return;
            }
            
            const listadoDestino = listados.find(l => l.id == listadoDestinoId);
            if (!listadoDestino) {
                alert('Listado destino no encontrado');
                return;
            }
            
            const lineas = texto.split('\n');
            let nuevosProductos = [];
            let productosDuplicados = 0;
            
            lineas.forEach(linea => {
                if (linea.trim() === '') return;
                
                const producto = analizarLineaProducto(linea);
                if (producto) {
                    // Verificar si el producto ya existe en el listado destino (comparando nombre Y categor칤a)
                    const existe = listadoDestino.productos.some(p => 
                        p.nombre.toLowerCase() === producto.nombre.toLowerCase() && 
                        p.categoria === producto.categoria
                    );
                    
                    if (!existe) {
                        nuevosProductos.push(producto);
                    } else {
                        productosDuplicados++;
                    }
                }
            });
            
            // Agregar nuevos productos al listado destino
            if (!listadoDestino.productos) {
                listadoDestino.productos = [];
            }
            
            listadoDestino.productos.push(...nuevosProductos);
            guardarEnLocalStorage();
            cargarListaListados();
            cerrarModalImportarProductos();
            
            // Actualizar productos nuevos
            cargarProductosNuevos();
            
            let mensaje = `Se importaron ${nuevosProductos.length} productos nuevos`;
            if (productosDuplicados > 0) {
                mensaje += ` (${productosDuplicados} productos duplicados no se agregaron)`;
            }
            alert(mensaje + '!');
        }

        function analizarLineaProducto(linea) {
            // Limpiar la l칤nea
            let limpia = linea.replace(/[九걿릠游꿍]/g, '')
                             .replace(/\.{2,}/g, ' ')
                             .replace(/\s+/g, ' ')
                             .trim();
            
            // Detectar categor칤a basada en emojis y palabras clave
            let categoria = "otros";
            let presentacion = "";
            
            // Detecci칩n por emojis
            if (linea.includes('游눍')) {
                categoria = "medicamento";
                presentacion = "Blister";
            } else if (linea.includes('游눌')) {
                categoria = "inyecciones";
                presentacion = "Ampolla";
            } else if (linea.includes('游빍')) {
                categoria = "cremas";
                presentacion = "Pomo";
            } else if (linea.includes('游늷')) {
                categoria = "operaciones";
            } else if (linea.includes('游볱')) {
                categoria = "lacteos";
                presentacion = "Libra";
            } else if (linea.includes('游녜')) {
                categoria = "colirio";
                presentacion = "Frasco";
            }
            
            // Detecci칩n por palabras clave (si no se detect칩 por emoji)
            if (categoria === "otros") {
                const lineaLower = linea.toLowerCase();
                if (/(칩vulo|ovulo|supositorio)/i.test(lineaLower)) {
                    categoria = "ovulos";
                    presentacion = "칍vulo";
                } else if (/(suspensi칩n|suspension|polvo|sobre|jarabe|frasco)/i.test(lineaLower)) {
                    categoria = "suspension";
                    presentacion = "Frasco";
                } else if (/(jeringa|sonda|trocar|guante|material.*operaci칩n|material.*operacion)/i.test(lineaLower)) {
                    categoria = "operaciones";
                } else if (/(crema|gel|ung칲ento|unguento|pomada|tubo)/i.test(lineaLower)) {
                    categoria = "cremas";
                    presentacion = "Tubo";
                } else if (/(inyecci칩n|inyeccion|ampolla|vial)/i.test(lineaLower)) {
                    categoria = "inyecciones";
                    presentacion = "Ampolla";
                } else if (/(blister|tableta|comprimido|c치psula|capsula|pastilla)/i.test(lineaLower)) {
                    categoria = "medicamento";
                    presentacion = "Blister";
                } else if (/(leche|queso|yogur|mantequilla|l치cteo|lacteo)/i.test(lineaLower)) {
                    categoria = "lacteos";
                    presentacion = /libra/i.test(lineaLower) ? "Libra" : (/litro/i.test(lineaLower) ? "Litro" : "Unidad");
                } else if (/(colirio|gotas.*ojos|oft치lmico|oftalmico)/i.test(lineaLower)) {
                    categoria = "colirio";
                    presentacion = "Frasco";
                } else if (esNombreMedicamento(limpia)) {
                    categoria = "medicamento";
                    presentacion = "Blister";
                }
            }
            
            // Extraer nombre y precio
            const match = limpia.match(/([A-Za-z][A-Za-z0-9\s\/]+?)\s*(?:\$?\s*)(\d+)/i);
            if (match && match.length >= 3) {
                let nombre = match[1].trim();
                const precio = parseInt(match[2]);
                
                // Limpiar y formatear nombre
                nombre = nombre.replace(/\$/g, '').trim();
                nombre = nombre.charAt(0).toUpperCase() + nombre.slice(1).toLowerCase();
                
                // Correcciones de nombres comunes
                const correcciones = {
                    'amitritilina': 'Amitriptilina',
                    'alodipino': 'Amlodipino',
                    'metroclopramida': 'Metoclopramida',
                    'terminafina': 'Terbinafina',
                    'tripleantibiotoc': 'Triple Antibi칩tico'
                };
                
                if (correcciones[nombre.toLowerCase()]) {
                    nombre = correcciones[nombre.toLowerCase()];
                }
                
                if (nombre && precio > 0) {
                    return {
                        id: Date.now() + Math.random(),
                        nombre: nombre,
                        precio: precio,
                        precioVentaElla: Math.round(precio * 0.9), // 90% del precio como precio de la proveedora
                        precioCosto: Math.round(precio * 0.7), // 70% del precio como costo
                        categoria: categoria,
                        presentacion: presentacion,
                        disponible: true,
                        fechaCreacion: new Date().toISOString() // MARCADO COMO NUEVO
                    };
                }
            }
            
            return null;
        }

        function esNombreMedicamento(texto) {
            const medicamentosComunes = [
                'amitriptilina', 'aceite de bacalao', 'amlodipino', 'amoxicilina', 'atenolol',
                'captopril', 'carbamazepina', 'cefalexina', 'dipirona', 'difenhidramina',
                'dimenhidrinato', 'dexametasona', 'enalapril', 'furosemida', 'fluconazol',
                'ibuprofeno', 'levotiroxina', 'loratadina', 'meloxicam', 'mebendazol',
                'metoclopramida', 'metronidazol', 'nifedipino', 'omeprazol', 'paracetamol',
                'clotrimazol', 'gentamicina', 'diclofenac', 'nistatina', 'terbinafina',
                'bacalao', 'complejo b', 'rosefin', 'vitamina', 'colirio'
            ];
            
            return medicamentosComunes.some(med => 
                texto.toLowerCase().includes(med.toLowerCase())
            );
        }

        // Funciones de Pedidos
        function cargarPedidosPendientes() {
            const container = document.getElementById('lista-pedidos-pendientes');
            const pedidosPendientes = pedidos.filter(p => !p.completado);
            
            if (pedidosPendientes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No hay pedidos pendientes</h3>
                        <p>Presiona el bot칩n + para agregar un nuevo pedido</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pedidosPendientes.map(pedido => `
                <div class="pedido-card" onclick="verDetallePedido(${pedido.id})">
                    <div class="pedido-header">
                        <div class="cliente-info">
                            <h3>${pedido.nombreCliente || 'Cliente'}</h3>
                            <div class="telefono">${pedido.telefono}</div>
                            <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 4px;">
                                <i class="fas fa-calendar"></i> ${new Date(pedido.fechaEntrega).toLocaleDateString('es-ES')}
                                ${pedido.fechaEntrega !== pedido.fecha ? '<span class="fecha-badge">Programado</span>' : ''}
                                <span class="categoria-badge" style="background: ${pedido.quienConsiguio === 'proveedora' ? '#8B5CF6' : '#10b981'}; color: white; margin-left: 8px;">
                                    ${pedido.quienConsiguio === 'proveedora' ? 'Proveedora' : 'T칰'}
                                </span>
                            </div>
                        </div>
                        <div class="pedido-actions">
                            <button class="btn btn-success" onclick="event.stopPropagation(); marcarCompletado(${pedido.id})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-edit" onclick="event.stopPropagation(); editarPedido(${pedido.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger" onclick="event.stopPropagation(); eliminarPedido(${pedido.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="productos-list">
                        ${pedido.productos.slice(0, 3).map(p => `
                            <div class="producto-item">
                                <span>${p.cantidad}x ${p.nombre}</span>
                                <span class="producto-detalle">($${p.precio} c/u) - $${p.precio * p.cantidad}</span>
                            </div>
                        `).join('')}
                        ${pedido.productos.length > 3 ? `<div style="color: var(--secondary); font-size: 0.8rem;">... y ${pedido.productos.length - 3} m치s</div>` : ''}
                    </div>
                    
                    ${pedido.direccion ? `
                        <div class="domicilio-info">
                            <strong>游늸 Domicilio:</strong> ${pedido.direccion}
                            ${pedido.precioDomicilio > 0 ? `<br><strong>Precio env칤o:</strong> $${pedido.precioDomicilio}` : ''}
                        </div>
                    ` : ''}
                    
                    <div style="text-align: right; margin-top: 12px; font-weight: bold;">
                        Total: $${calcularTotalPedido(pedido)}
                        ${usuarioLogueado ? `<br><small style="color: #10b981;">Ganancia: $${calcularGananciaPedido(pedido)}</small>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function cargarProductosParaClientes() {
            const container = document.getElementById('lista-productos-cliente');
            let todosLosProductos = [];
            
            // Obtener todos los productos de todos los listados (solo disponibles)
            listados.forEach(listado => {
                if (listado.productos) {
                    const productosDisponibles = listado.productos.filter(p => p.disponible !== false);
                    todosLosProductos = todosLosProductos.concat(productosDisponibles);
                }
            });
            
            if (todosLosProductos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No hay productos disponibles</h3>
                        <p>Los productos aparecer치n aqu칤 cuando est칠n disponibles</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar productos por categor칤a
            const productosOrdenados = ordenarProductosPorCategoria(todosLosProductos);
            
            container.innerHTML = productosOrdenados.map(grupo => `
                <div style="margin-bottom: 24px;">
                    <h3 style="padding: 12px; background: var(--surface); border-radius: 8px; margin-bottom: 8px;">
                        ${obtenerNombreCategoria(grupo.categoria)}
                    </h3>
                    ${grupo.productos.map(producto => `
                        <div class="producto-card">
                            <div class="producto-info">
                                <h4>${producto.nombre}</h4>
                                <div style="font-size: 0.8rem; color: var(--secondary);">
                                    $${producto.precio}
                                    ${producto.presentacion ? `  ${producto.presentacion}` : ''}
                                </div>
                            </div>
                            <div class="producto-precio">
                                $${producto.precio}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function verDetallePedido(id) {
            const pedido = pedidos.find(p => p.id === id);
            if (!pedido) return;
            
            const container = document.getElementById('detalle-pedido-contenido');
            const total = calcularTotalPedido(pedido);
            const ganancia = calcularGananciaPedido(pedido);
            const costo = calcularCostoPedido(pedido);
            
            container.innerHTML = `
                <div class="pedido-detalle">
                    <div class="detalle-item">
                        <span class="detalle-label">Cliente:</span>
                        <span class="detalle-value">${pedido.nombreCliente || 'No especificado'}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Tel칠fono:</span>
                        <span class="detalle-value">${pedido.telefono}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Consigui칩 el cliente:</span>
                        <span class="detalle-value" style="color: ${pedido.quienConsiguio === 'proveedora' ? '#8B5CF6' : '#10b981'}; font-weight: bold;">
                            ${pedido.quienConsiguio === 'proveedora' ? 'La proveedora' : 'T칰'}
                        </span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Fecha de Pedido:</span>
                        <span class="detalle-value">${new Date(pedido.fecha).toLocaleString()}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Fecha de Entrega:</span>
                        <span class="detalle-value">${new Date(pedido.fechaEntrega).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                    </div>
                    ${pedido.direccion ? `
                    <div class="detalle-item">
                        <span class="detalle-label">Direcci칩n:</span>
                        <span class="detalle-value">${pedido.direccion}</span>
                    </div>
                    <div class="detalle-item">
                        <span class="detalle-label">Precio domicilio:</span>
                        <span class="detalle-value">$${pedido.precioDomicilio || 0}</span>
                    </div>
                    ` : ''}
                    ${usuarioLogueado ? `
                    <div class="detalle-item" style="color: #dc2626; font-weight: bold;">
                        <span class="detalle-label">Costo Total:</span>
                        <span class="detalle-value">$${costo}</span>
                    </div>
                    <div class="detalle-item" style="color: #10b981; font-weight: bold;">
                        <span class="detalle-label">Ganancia:</span>
                        <span class="detalle-value">$${ganancia}</span>
                    </div>
                    ` : ''}
                </div>
                
                <h3 style="margin: 16px 0 8px 0;">Productos:</h3>
                <div class="productos-list">
                    ${pedido.productos.map(p => {
                        const productoOriginal = buscarProductoOriginal(p.id);
                        const precioUsado = pedido.quienConsiguio === 'proveedora' ? (p.precioVentaElla || p.precio) : p.precio;
                        const gananciaProducto = productoOriginal ? (precioUsado - (productoOriginal.precioCosto || 0)) * p.cantidad : 0;
                        const costoProducto = productoOriginal ? (productoOriginal.precioCosto || 0) * p.cantidad : 0;
                        
                        return `
                            <div class="producto-item">
                                <div>
                                    <span>${p.cantidad}x ${p.nombre}</span>
                                    <span class="producto-detalle">
                                        ($${precioUsado} c/u) - $${precioUsado * p.cantidad}
                                        ${pedido.quienConsiguio === 'proveedora' ? '<small style="color: #8B5CF6;"> (precio proveedora)</small>' : ''}
                                    </span>
                                </div>
                                ${usuarioLogueado && productoOriginal ? `
                                <div style="text-align: right;">
                                    <div style="color: #dc2626; font-size: 0.8rem;">Costo: $${costoProducto}</div>
                                    <div style="color: #10b981; font-size: 0.8rem;">Ganancia: $${gananciaProducto}</div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="total-section">
                    Total: $${total}
                    ${usuarioLogueado ? `
                    <br>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 1rem;">
                        <span style="color: #dc2626;">Costo: $${costo}</span>
                        <span style="color: #10b981;">Ganancia: $${ganancia}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Guardar el pedido actual para compartir
            window.pedidoACompartir = pedido;
            window.totalACompartir = total;
            
            // Mostrar bot칩n de compartir con proveedora solo si hay usuario logueado
            if (usuarioLogueado) {
                document.getElementById('btnCompartirProveedora').style.display = 'block';
            }
            
            document.getElementById('modalDetallePedido').style.display = 'flex';
        }

        function cerrarModalDetallePedido() {
            document.getElementById('modalDetallePedido').style.display = 'none';
            document.getElementById('btnCompartirProveedora').style.display = 'none';
        }

        function compartirPedido() {
            if (!window.pedidoACompartir) return;
            
            const pedido = window.pedidoACompartir;
            const total = window.totalACompartir;
            
            let mensaje = `춰Hola! Aqu칤 est치 el resumen de tu pedido:\n\n`;
            mensaje += `*Cliente:* ${pedido.nombreCliente || 'No especificado'}\n`;
            mensaje += `*Tel칠fono:* ${pedido.telefono}\n`;
            mensaje += `*Fecha de Entrega:* ${new Date(pedido.fechaEntrega).toLocaleDateString('es-ES')}\n\n`;
            mensaje += `*Productos:*\n`;
            
            pedido.productos.forEach(p => {
                const precio = pedido.quienConsiguio === 'proveedora' ? (p.precioVentaElla || p.precio) : p.precio;
                mensaje += ` ${p.cantidad}x ${p.nombre} ($${precio} c/u) - $${precio * p.cantidad}\n`;
            });
            
            mensaje += `\n`;
            
            if (pedido.direccion) {
                mensaje += `*Domicilio:* ${pedido.direccion}\n`;
                mensaje += `*Precio env칤o:* $${pedido.precioDomicilio || 0}\n`;
            }
            
            mensaje += `\n*TOTAL: $${total}*`;
            mensaje += `\n\n춰Gracias por tu compra! 游꿀`;
            
            // Codificar el mensaje para URL - Ahora abre el selector de contactos
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/?text=${mensajeCodificado}`;
            
            // Abrir en nueva ventana (esto abrir치 el selector de contactos de WhatsApp)
            window.open(urlWhatsApp, '_blank');
        }

        // Funciones de Calendario
        function abrirCalendario() {
            fechaSeleccionadaCalendario = new Date(document.getElementById('fechaEntrega').value);
            mesActualCalendario = fechaSeleccionadaCalendario.getMonth();
            a침oActualCalendario = fechaSeleccionadaCalendario.getFullYear();
            generarCalendario();
            document.getElementById('modalCalendario').style.display = 'flex';
        }

        function cerrarCalendario() {
            document.getElementById('modalCalendario').style.display = 'none';
        }

        function generarCalendario() {
            const calendario = document.getElementById('calendario');
            const mesActualElement = document.getElementById('mesActual');
            
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            mesActualElement.textContent = `${meses[mesActualCalendario]} ${a침oActualCalendario}`;
            
            const primerDia = new Date(a침oActualCalendario, mesActualCalendario, 1);
            const ultimoDia = new Date(a침oActualCalendario, mesActualCalendario + 1, 0);
            const primerDiaSemana = primerDia.getDay();
            const totalDias = ultimoDia.getDate();
            
            let html = '';
            
            // D칤as de la semana
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];
            diasSemana.forEach(dia => {
                html += `<div style="text-align: center; font-weight: bold; padding: 8px;">${dia}</div>`;
            });
            
            // D칤as vac칤os al inicio
            for (let i = 0; i < primerDiaSemana; i++) {
                html += `<div class="calendar-day other-month"></div>`;
            }
            
            // D칤as del mes
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            for (let dia = 1; dia <= totalDias; dia++) {
                const fecha = new Date(a침oActualCalendario, mesActualCalendario, dia);
                const esHoy = fecha.toDateString() === hoy.toDateString();
                const esSeleccionado = fecha.toDateString() === fechaSeleccionadaCalendario.toDateString();
                const clases = ['calendar-day'];
                
                if (esHoy) clases.push('today');
                if (esSeleccionado) clases.push('selected');
                if (fecha < hoy) clases.push('other-month');
                
                html += `<div class="${clases.join(' ')}" onclick="seleccionarDia(${dia})">${dia}</div>`;
            }
            
            calendario.innerHTML = html;
        }

        function seleccionarDia(dia) {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const fechaSeleccionada = new Date(a침oActualCalendario, mesActualCalendario, dia);
            
            if (fechaSeleccionada < hoy) {
                alert('No puedes seleccionar una fecha pasada');
                return;
            }
            
            fechaSeleccionadaCalendario = fechaSeleccionada;
            generarCalendario();
        }

        function cambiarMes(direccion) {
            mesActualCalendario += direccion;
            if (mesActualCalendario < 0) {
                mesActualCalendario = 11;
                a침oActualCalendario--;
            } else if (mesActualCalendario > 11) {
                mesActualCalendario = 0;
                a침oActualCalendario++;
            }
            generarCalendario();
        }

        function seleccionarFecha() {
            document.getElementById('fechaEntrega').value = fechaSeleccionadaCalendario.toISOString().split('T')[0];
            const fechaFormateada = fechaSeleccionadaCalendario.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const esHoy = fechaSeleccionadaCalendario.toDateString() === new Date().toDateString();
            document.getElementById('fechaSeleccionada').innerHTML = `${esHoy ? 'Hoy' : 'Entrega'}: ${fechaFormateada}`;
            cerrarCalendario();
        }

        function abrirModalPedido() {
            pedidoEditando = null;
            document.getElementById('modalTitulo').textContent = 'Nuevo Pedido';
            document.getElementById('formPedido').reset();
            document.getElementById('productosSeleccionados').innerHTML = '';
            productosSeleccionados = [];
            document.getElementById('quienConsiguioCliente').value = 'yo';
            actualizarTotalSegunQuienConsiguio();
            
            // Establecer fecha por defecto (hoy)
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEntrega').value = hoy;
            document.getElementById('fechaSeleccionada').innerHTML = `Hoy: ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            document.getElementById('modalPedido').style.display = 'flex';
        }

        function cerrarModalPedido() {
            document.getElementById('modalPedido').style.display = 'none';
        }

        function guardarPedido(event) {
            event.preventDefault();
            
            const telefono = document.getElementById('telefonoCliente').value;
            if (!telefono) {
                alert('El tel칠fono es obligatorio');
                return;
            }
            
            const direccion = document.getElementById('incluirDomicilio').checked ? document.getElementById('direccion').value : '';
            if (document.getElementById('incluirDomicilio').checked && !direccion) {
                alert('La direcci칩n es obligatoria cuando se incluye domicilio');
                return;
            }
            
            const pedido = {
                id: pedidoEditando ? pedidoEditando.id : Date.now(),
                nombreCliente: document.getElementById('nombreCliente').value,
                telefono: telefono,
                quienConsiguio: document.getElementById('quienConsiguioCliente').value,
                productos: [...productosSeleccionados],
                direccion: direccion,
                precioDomicilio: document.getElementById('incluirDomicilio').checked ? parseInt(document.getElementById('precioDomicilio').value) || 0 : 0,
                fecha: new Date().toISOString(),
                fechaEntrega: document.getElementById('fechaEntrega').value,
                completado: false
            };
            
            if (pedidoEditando) {
                // Actualizar pedido existente
                const index = pedidos.findIndex(p => p.id === pedidoEditando.id);
                pedidos[index] = pedido;
            } else {
                // Agregar nuevo pedido
                pedidos.push(pedido);
            }
            
            guardarEnLocalStorage();
            cargarPedidosPendientes();
            cerrarModalPedido();
            
            alert('Pedido guardado exitosamente!');
        }

        function editarPedido(id) {
            pedidoEditando = pedidos.find(p => p.id === id);
            if (!pedidoEditando) return;
            
            document.getElementById('modalTitulo').textContent = 'Editar Pedido';
            document.getElementById('pedidoId').value = pedidoEditando.id;
            document.getElementById('nombreCliente').value = pedidoEditando.nombreCliente || '';
            document.getElementById('telefonoCliente').value = pedidoEditando.telefono;
            document.getElementById('quienConsiguioCliente').value = pedidoEditando.quienConsiguio || 'yo';
            document.getElementById('fechaEntrega').value = pedidoEditando.fechaEntrega;
            
            const fechaEntrega = new Date(pedidoEditando.fechaEntrega);
            const esHoy = fechaEntrega.toDateString() === new Date().toDateString();
            const fechaFormateada = fechaEntrega.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('fechaSeleccionada').innerHTML = `${esHoy ? 'Hoy' : 'Entrega'}: ${fechaFormateada}`;
            
            productosSeleccionados = [...pedidoEditando.productos];
            actualizarListaProductosSeleccionados();
            actualizarTotalSegunQuienConsiguio();
            
            if (pedidoEditando.direccion) {
                document.getElementById('incluirDomicilio').checked = true;
                toggleDomicilio();
                document.getElementById('direccion').value = pedidoEditando.direccion;
                document.getElementById('precioDomicilio').value = pedidoEditando.precioDomicilio || 0;
            }
            
            actualizarTotal();
            document.getElementById('modalPedido').style.display = 'flex';
        }

        function marcarCompletado(id) {
            if (confirm('쯄arcar este pedido como completado?')) {
                const pedido = pedidos.find(p => p.id === id);
                if (pedido) {
                    pedido.completado = true;
                    pedido.fechaCompletado = new Date().toISOString();
                    guardarEnLocalStorage();
                    cargarPedidosPendientes();
                    cargarHistorial();
                }
            }
        }

        function eliminarPedido(id) {
            if (confirm('쮼st치s seguro de eliminar este pedido?')) {
                pedidos = pedidos.filter(p => p.id !== id);
                guardarEnLocalStorage();
                cargarPedidosPendientes();
                cargarHistorial();
            }
        }

        // Funciones para selecci칩n de productos
        function abrirModalSeleccionProductos() {
            // Cargar listados en el modal
            const containerListados = document.getElementById('lista-listados-modal');
            containerListados.innerHTML = listados.map(listado => `
                <div class="listado-card" onclick="seleccionarListado(${listado.id})" style="margin-bottom: 8px; cursor: pointer;">
                    <div class="listado-header">
                        <h3>${listado.nombre}</h3>
                        <div class="listado-count">
                            ${listado.productos ? listado.productos.length : 0} productos
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('modalProductos').style.display = 'flex';
        }

        function seleccionarListado(id) {
            listadoSeleccionado = listados.find(l => l.id === id);
            if (!listadoSeleccionado) return;
            
            cargarProductosParaSeleccion();
        }

        function cargarProductosParaSeleccion() {
            const container = document.getElementById('lista-productos-modal');
            const productos = listadoSeleccionado.productos || [];
            
            if (productos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>No hay productos</h3>
                        <p>Este listado est치 vac칤o</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar productos por categor칤a y alfab칠ticamente para la selecci칩n
            const productosOrdenados = ordenarProductosPorCategoria(productos);
            
            container.innerHTML = productosOrdenados.map(grupo => `
                <div style="margin-bottom: 16px;">
                    <h4 style="padding: 8px; background: #f1f5f9; border-radius: 6px; font-size: 0.8rem;">
                        ${obtenerNombreCategoria(grupo.categoria)}
                    </h4>
                    ${grupo.productos.map(producto => {
                        if (producto.disponible === false) return '';
                        
                        return `
                            <div class="checkbox-group" style="padding: 8px; border-bottom: 1px solid #f1f5f9;">
                                <input type="checkbox" id="prod-${producto.id}" value="${producto.id}">
                                <label for="prod-${producto.id}" style="flex: 1;">
                                    <strong>${producto.nombre}</strong> 
                                    <br><small>Tu precio: $${producto.precio} | Precio proveedora: $${producto.precioVentaElla || producto.precio}</small>
                                    ${usuarioLogueado && producto.precioCosto ? `<br><small style="color: #10b981;">Costo: $${producto.precioCosto}</small>` : ''}
                                    ${producto.presentacion ? ` (${producto.presentacion})` : ''}
                                </label>
                                <input type="number" min="1" value="1" style="width: 60px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px;" id="cant-${producto.id}">
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function cerrarModalProductos() {
            document.getElementById('modalProductos').style.display = 'none';
        }

        function agregarProductosSeleccionados() {
            if (!listadoSeleccionado) {
                alert('Por favor selecciona un listado primero');
                return;
            }
            
            const productos = listadoSeleccionado.productos || [];
            const quienConsiguio = document.getElementById('quienConsiguioCliente').value;
            
            productos.forEach(producto => {
                const checkbox = document.getElementById(`prod-${producto.id}`);
                const cantidadInput = document.getElementById(`cant-${producto.id}`);
                
                if (checkbox && checkbox.checked && producto.disponible !== false) {
                    const cantidad = parseInt(cantidadInput.value) || 1;
                    
                    // Verificar si el producto ya est치 seleccionado
                    const index = productosSeleccionados.findIndex(p => p.id === producto.id);
                    if (index !== -1) {
                        productosSeleccionados[index].cantidad += cantidad;
                    } else {
                        productosSeleccionados.push({
                            ...producto,
                            cantidad: cantidad,
                            // Guardamos ambos precios para usarlos seg칰n qui칠n consigui칩 al cliente
                            precioVentaElla: producto.precioVentaElla || producto.precio
                        });
                    }
                }
            });
            
            actualizarListaProductosSeleccionados();
            cerrarModalProductos();
        }

        function actualizarListaProductosSeleccionados() {
            const container = document.getElementById('productosSeleccionados');
            const quienConsiguio = document.getElementById('quienConsiguioCliente').value;
            
            container.innerHTML = productosSeleccionados.map((producto, index) => {
                const productoOriginal = buscarProductoOriginal(producto.id);
                const precioUsado = quienConsiguio === 'yo' ? producto.precio : (producto.precioVentaElla || producto.precio);
                const gananciaProducto = productoOriginal ? (precioUsado - (productoOriginal.precioCosto || 0)) * producto.cantidad : 0;
                
                return `
                    <div class="producto-seleccionado">
                        <div>
                            <strong>${producto.cantidad}x ${producto.nombre}</strong>
                            <br><small>$${precioUsado} c/u ${quienConsiguio === 'proveedora' ? '(precio proveedora)' : ''}</small>
                            ${usuarioLogueado && productoOriginal ? `<br><small style="color: #10b981;">Ganancia: $${gananciaProducto}</small>` : ''}
                        </div>
                        <div>
                            <strong>$${precioUsado * producto.cantidad}</strong>
                            <button type="button" onclick="eliminarProductoSeleccionado(${index})" style="background: none; border: none; color: var(--danger); margin-left: 8px; cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            actualizarTotal();
        }

        function eliminarProductoSeleccionado(index) {
            productosSeleccionados.splice(index, 1);
            actualizarListaProductosSeleccionados();
        }

        function actualizarTotal() {
            const quienConsiguio = document.getElementById('quienConsiguioCliente').value;
            const totalProductos = productosSeleccionados.reduce((sum, p) => {
                const precio = quienConsiguio === 'yo' ? p.precio : (p.precioVentaElla || p.precio);
                return sum + (precio * p.cantidad);
            }, 0);
            const precioDomicilio = document.getElementById('incluirDomicilio').checked ? 
                parseInt(document.getElementById('precioDomicilio').value) || 0 : 0;
            
            const total = totalProductos + precioDomicilio;
            document.getElementById('totalPedido').textContent = total;
        }

        function toggleDomicilio() {
            const domicilioFields = document.getElementById('domicilioFields');
            if (document.getElementById('incluirDomicilio').checked) {
                domicilioFields.classList.remove('hidden');
            } else {
                domicilioFields.classList.add('hidden');
            }
            actualizarTotal();
        }

        function filtrarProductos() {
            const busqueda = document.getElementById('buscarProducto').value.toLowerCase();
            const items = document.querySelectorAll('#lista-productos-modal .checkbox-group');
            
            items.forEach(item => {
                const texto = item.textContent.toLowerCase();
                item.style.display = texto.includes(busqueda) ? 'flex' : 'none';
            });
        }

        // Funciones de Estad칤sticas
        function cargarEstadisticas() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const mes = document.getElementById('filtroMes').value;
            const a침o = document.getElementById('filtroA침o').value;
            
            const pedidosCompletados = pedidos.filter(p => p.completado);
            let pedidosFiltrados = [];
            
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            switch (periodo) {
                case 'dia':
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        fechaPedido.setHours(0, 0, 0, 0);
                        return fechaPedido.getTime() === hoy.getTime();
                    });
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        return fechaPedido >= inicioSemana;
                    });
                    break;
                case 'mes':
                    if (mes) {
                        const [a침oMes, mesNum] = mes.split('-');
                        const inicioMes = new Date(a침oMes, mesNum - 1, 1);
                        const finMes = new Date(a침oMes, mesNum, 0);
                        pedidosFiltrados = pedidosCompletados.filter(p => {
                            const fechaPedido = new Date(p.fechaCompletado);
                            return fechaPedido >= inicioMes && fechaPedido <= finMes;
                        });
                    } else {
                        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                        pedidosFiltrados = pedidosCompletados.filter(p => {
                            const fechaPedido = new Date(p.fechaCompletado);
                            return fechaPedido >= inicioMes;
                        });
                    }
                    break;
                case 'a침o':
                    const a침oFiltro = a침o || hoy.getFullYear();
                    const inicioA침o = new Date(a침oFiltro, 0, 1);
                    const finA침o = new Date(a침oFiltro, 11, 31);
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        return fechaPedido >= inicioA침o && fechaPedido <= finA침o;
                    });
                    break;
                case 'todo':
                    pedidosFiltrados = pedidosCompletados;
                    break;
            }
            
            mostrarEstadisticas(pedidosFiltrados, periodo);
        }

        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T칤tulo
            doc.setFontSize(20);
            doc.text('Reporte de Ventas - Delivery Farmacia', 20, 20);
            
            // Fecha de generaci칩n
            doc.setFontSize(10);
            doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 20, 30);
            
            // Estad칤sticas principales
            const periodo = document.getElementById('filtroPeriodo').value;
            const pedidosCompletados = pedidos.filter(p => p.completado);
            let pedidosFiltrados = [];
            
            // Aplicar mismos filtros que en las estad칤sticas
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            switch (periodo) {
                case 'dia':
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        fechaPedido.setHours(0, 0, 0, 0);
                        return fechaPedido.getTime() === hoy.getTime();
                    });
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoy);
                    inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        return fechaPedido >= inicioSemana;
                    });
                    break;
                case 'mes':
                    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        return fechaPedido >= inicioMes;
                    });
                    break;
                case 'a침o':
                    const inicioA침o = new Date(hoy.getFullYear(), 0, 1);
                    pedidosFiltrados = pedidosCompletados.filter(p => {
                        const fechaPedido = new Date(p.fechaCompletado);
                        return fechaPedido >= inicioA침o;
                    });
                    break;
                case 'todo':
                    pedidosFiltrados = pedidosCompletados;
                    break;
            }
            
            const totalVentas = pedidosFiltrados.reduce((sum, p) => sum + calcularTotalPedido(p), 0);
            const promedioVenta = totalVentas / (pedidosFiltrados.length || 1);
            const totalProductos = pedidosFiltrados.reduce((sum, p) => sum + p.productos.reduce((sumProd, prod) => sumProd + prod.cantidad, 0), 0);
            
            // Calcular ganancias si hay usuario logueado
            let totalCosto = 0;
            let gananciaTotal = 0;
            
            if (usuarioLogueado) {
                pedidosFiltrados.forEach(pedido => {
                    const costoPedido = pedido.productos.reduce((sum, productoPedido) => {
                        const productoOriginal = buscarProductoOriginal(productoPedido.id);
                        if (productoOriginal && productoOriginal.precioCosto) {
                            return sum + (productoOriginal.precioCosto * productoPedido.cantidad);
                        }
                        return sum;
                    }, 0);
                    totalCosto += costoPedido;
                    gananciaTotal += calcularTotalPedido(pedido) - costoPedido + (pedido.precioDomicilio || 0);
                });
            }
            
            // Estad칤sticas en PDF
            doc.setFontSize(12);
            doc.text(`Per칤odo: ${document.getElementById('filtroPeriodo').options[document.getElementById('filtroPeriodo').selectedIndex].text}`, 20, 45);
            doc.text(`Total Pedidos: ${pedidosFiltrados.length}`, 20, 55);
            doc.text(`Total Ventas: $${totalVentas.toLocaleString()}`, 20, 65);
            doc.text(`Promedio por Pedido: $${promedioVenta.toFixed(2)}`, 20, 75);
            doc.text(`Total Productos Vendidos: ${totalProductos}`, 20, 85);
            
            if (usuarioLogueado) {
                doc.setTextColor(220, 38, 38); // Color rojo para costos
                doc.text(`Costo Total: $${totalCosto.toLocaleString()}`, 20, 95);
                doc.setTextColor(16, 185, 129); // Color verde para ganancias
                doc.text(`Ganancia Neta: $${gananciaTotal.toLocaleString()}`, 20, 105);
                doc.setTextColor(0, 0, 0); // Volver a color negro
            }
            
            // Productos m치s vendidos
            const productosVendidos = {};
            pedidosFiltrados.forEach(pedido => {
                pedido.productos.forEach(producto => {
                    if (!productosVendidos[producto.nombre]) {
                        productosVendidos[producto.nombre] = 0;
                    }
                    productosVendidos[producto.nombre] += producto.cantidad;
                });
            });
            
            const productosTop = Object.entries(productosVendidos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let yPos = 120;
            doc.text('Productos M치s Vendidos:', 20, yPos);
            yPos += 10;
            
            productosTop.forEach(([producto, cantidad], index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.text(`${index + 1}. ${producto}: ${cantidad} unidades`, 25, yPos);
                yPos += 7;
            });
            
            // Guardar PDF
            doc.save(`reporte-ventas-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function limpiarTodo() {
            if (confirm('쮼ST츼S SEGURO DE LIMPIAR TODO? Se eliminar치n todos los pedidos, listados y productos. Esta acci칩n no se puede deshacer.')) {
                pedidos = [];
                listados = [];
                guardarEnLocalStorage();
                cargarPedidosPendientes();
                cargarListaListados();
                cargarHistorial();
                cargarProductosNuevos();
                alert('Todos los datos han sido eliminados');
            }
        }

        function actualizarEstadisticas() {
            document.getElementById('totalPedidos').textContent = pedidos.length;
            document.getElementById('totalListados').textContent = listados.length;
            
            let totalProductos = 0;
            listados.forEach(listado => {
                totalProductos += listado.productos ? listado.productos.length : 0;
            });
            document.getElementById('totalProductos').textContent = totalProductos;
            
            // Actualizar contador de productos nuevos
            const unaSemanaAtras = new Date();
            unaSemanaAtras.setDate(unaSemanaAtras.getDate() - 7);
            let totalProductosNuevos = 0;
            
            listados.forEach(listado => {
                if (listado.productos) {
                    const productosNuevos = listado.productos.filter(p => {
                        if (!p.fechaCreacion) return false;
                        const fechaCreacion = new Date(p.fechaCreacion);
                        return fechaCreacion >= unaSemanaAtras && p.disponible !== false;
                    });
                    totalProductosNuevos += productosNuevos.length;
                }
            });
            
            document.getElementById('totalProductosNuevos').textContent = totalProductosNuevos;
        }

        // Funciones para los modales de importaci칩n
        function abrirModalImportarProductos() {
            // Cargar listados en el select
            const select = document.getElementById('listadoDestino');
            select.innerHTML = '<option value="">Seleccionar listado destino</option>' +
                listados.map(listado => `
                    <option value="${listado.id}">${listado.nombre}</option>
                `).join('');
            
            document.getElementById('modalImportarProductos').style.display = 'flex';
        }

        function cerrarModalImportarProductos() {
            document.getElementById('modalImportarProductos').style.display = 'none';
        }
    </script>
</body>
</html>